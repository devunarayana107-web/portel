<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSXpertise - Assessment Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // DATA LAYER
        const DB_KEYS = {
            SSC: 'se_ssc', QP: 'se_qp', NOS: 'se_nos', PC: 'se_pc',
            BATCHES: 'se_batches', STUDENTS: 'se_students',
            QUESTION_PAPERS: 'se_question_papers',
            RESPONSES: 'se_responses', MANUAL_CAPTURES: 'se_manual_captures'
        };

        // IndexedDB for Large Video Storage
        const VideoDB = {
            dbName: 'ProctoringDB',
            storeName: 'videos',
            init: async () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(VideoDB.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(VideoDB.storeName)) {
                            db.createObjectStore(VideoDB.storeName);
                        }
                    };
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            saveVideo: async (key, blob) => {
                const db = await VideoDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(VideoDB.storeName, 'readwrite');
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                    tx.objectStore(VideoDB.storeName).put(blob, key);
                });
            },
            getVideo: async (key) => {
                const db = await VideoDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(VideoDB.storeName, 'readonly');
                    const store = tx.objectStore(VideoDB.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }
        };

        window.Utils = {
            generateId: () => 'id_' + Math.random().toString(36).substr(2, 9) + Date.now(),
            getSSC: () => JSON.parse(localStorage.getItem(DB_KEYS.SSC) || '[]'),
            saveSSC: (ssc) => { const list = window.Utils.getSSC(); list.push(ssc); localStorage.setItem(DB_KEYS.SSC, JSON.stringify(list)); },
            deleteSSC: (id) => { let list = window.Utils.getSSC().filter(s => s.id !== id); localStorage.setItem(DB_KEYS.SSC, JSON.stringify(list)); },
            getQPs: () => JSON.parse(localStorage.getItem(DB_KEYS.QP) || '[]'),
            getQPsBySSC: (sscId) => window.Utils.getQPs().filter(q => q.sscId === sscId),
            saveQP: (qp) => { const list = window.Utils.getQPs(); list.push(qp); localStorage.setItem(DB_KEYS.QP, JSON.stringify(list)); },
            deleteQP: (id) => { let list = window.Utils.getQPs().filter(q => q.id !== id); localStorage.setItem(DB_KEYS.QP, JSON.stringify(list)); },
            getNOS: () => JSON.parse(localStorage.getItem(DB_KEYS.NOS) || '[]'),
            getNOSByQP: (qpId) => window.Utils.getNOS().filter(n => n.qpId === qpId),
            saveNOS: (nos) => { const list = window.Utils.getNOS(); list.push(nos); localStorage.setItem(DB_KEYS.NOS, JSON.stringify(list)); },
            deleteNOS: (id) => { let list = window.Utils.getNOS().filter(n => n.id !== id); localStorage.setItem(DB_KEYS.NOS, JSON.stringify(list)); },
            getPCs: () => JSON.parse(localStorage.getItem(DB_KEYS.PC) || '[]'),
            getPCsByNOS: (nosId) => window.Utils.getPCs().filter(p => p.nosId === nosId),
            savePC: (pc) => { const list = window.Utils.getPCs(); list.push(pc); localStorage.setItem(DB_KEYS.PC, JSON.stringify(list)); },
            deletePC: (id) => { let list = window.Utils.getPCs().filter(p => p.id !== id); localStorage.setItem(DB_KEYS.PC, JSON.stringify(list)); },
            getBatches: () => JSON.parse(localStorage.getItem(DB_KEYS.BATCHES) || '[]'),
            saveBatch: (batch) => { const list = window.Utils.getBatches(); list.push(batch); localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(list)); },
            updateBatches: (batches) => localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(batches)),
            deleteBatch: (id) => {
                let list = window.Utils.getBatches().filter(b => b.id !== id);
                localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(list));
                let students = window.Utils.getStudents().filter(s => s.batchId !== id);
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(students));
            },
            getStudents: () => JSON.parse(localStorage.getItem(DB_KEYS.STUDENTS) || '[]'),
            getStudentsByBatch: (batchId) => window.Utils.getStudents().filter(s => s.batchId === batchId),
            saveStudent: (student) => { const list = window.Utils.getStudents(); list.push(student); localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(list)); },
            deleteStudent: (id) => { let list = window.Utils.getStudents().filter(s => s.id !== id); localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(list)); },
            authenticateStudent: (username, password) => window.Utils.getStudents().find(s => String(s.username).trim() === String(username).trim() && String(s.password).trim() === String(password).trim()),
            getQuestionPapers: () => JSON.parse(localStorage.getItem(DB_KEYS.QUESTION_PAPERS) || '[]'),
            saveQuestionPaper: (qp) => { const list = window.Utils.getQuestionPapers(); list.push(qp); localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(list)); },
            deleteQuestionPaper: (id) => { let list = window.Utils.getQuestionPapers().filter(q => q.id !== id); localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(list)); },
            getResponses: () => JSON.parse(localStorage.getItem(DB_KEYS.RESPONSES) || '[]'),
            saveResponse: (response) => {
                const list = window.Utils.getResponses();
                const existing = list.findIndex(r => r.studentId === response.studentId && r.examType === response.examType);
                if (existing >= 0) {
                    const old = list[existing];
                    // Smart Merge: Append evidence if new exists
                    let newEvidence = old.evidence || [];
                    if (response.evidence) {
                        newEvidence = [...newEvidence, ...response.evidence];
                    }
                    list[existing] = { ...old, ...response, evidence: newEvidence };
                }
                else list.push(response);
                try {
                    localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(list));
                } catch (e) {
                    console.error("Storage Full", e);
                    alert("Storage Full! Evidence may not be saved. Please contact Assessor.");
                }
            },
            authenticateAssessor: (username, password) => {
                // Failsafe for testing: If default creds used, try to return the FIRST batch found, so data appears.
                if (username === 'assessor' && password === 'password') {
                    const batches = window.Utils.getBatches();
                    if (batches.length > 0) return batches[0];
                    return { id: 'default_override', name: 'Default Batch', assessorUsername: 'assessor' };
                }

                return window.Utils.getBatches().find(b =>
                    String(b.assessorUsername).trim() === String(username).trim() &&
                    String(b.assessorPassword).trim() === String(password).trim()
                );
            }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // Safe Icon Component
        const LucideIcon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    window.lucide.createIcons({
                        attrs: { class: className },
                        nameAttr: 'data-lucide',
                        icons: { [name]: window.lucide.icons[name] }, // Pass specific icon
                        root: ref.current.parentNode // Create icons in parent? No, createIcons searches inside root.
                    });
                    // Actually createIcons replaces elements with data-lucide.
                    // We need to render <i data-lucide={name} /> and let lucide replace it.
                    // BUT we want to scope it.
                    window.lucide.createIcons({
                        root: ref.current,
                        icons: window.lucide.icons,
                        attrs: { class: className }
                    });
                }
            }, [name, className]);

            return <span ref={ref}><i data-lucide={name} className={className}></i></span>;
        };

        const Icons = {
            User: () => <LucideIcon name="user" className="w-5 h-5" />,
            Users: () => <LucideIcon name="users" className="w-5 h-5" />,
            LogOut: () => <LucideIcon name="log-out" className="w-5 h-5" />,
            Camera: () => <LucideIcon name="camera" className="w-5 h-5" />,
            Plus: () => <LucideIcon name="plus" className="w-5 h-5" />,
            Trash2: () => <LucideIcon name="trash-2" className="w-4 h-4" />,
            Eye: () => <LucideIcon name="eye" className="w-5 h-5" />,
            Upload: () => <LucideIcon name="upload" className="w-5 h-5" />,
            Download: () => <LucideIcon name="download" className="w-5 h-5" />,
            FileText: () => <LucideIcon name="file-text" className="w-5 h-5" />,
            Book: () => <LucideIcon name="book" className="w-5 h-5" />,
            Cpu: () => <LucideIcon name="cpu" className="w-5 h-5" />,
            Edit3: () => <LucideIcon name="edit-3" className="w-4 h-4" />,
            UserPlus: () => <LucideIcon name="user-plus" className="w-5 h-5" />,
            ChevronDown: () => <LucideIcon name="chevron-down" className="w-4 h-4" />,
            ChevronRight: () => <LucideIcon name="chevron-right" className="w-4 h-4" />,
            Grid: () => <LucideIcon name="grid" className="w-5 h-5" />,
            Calendar: () => <LucideIcon name="calendar" className="w-5 h-5" />,
            MapPin: () => <LucideIcon name="map-pin" className="w-5 h-5" />,
            Layers: () => <LucideIcon name="layers" className="w-5 h-5" />,
            List: () => <LucideIcon name="list" className="w-5 h-5" />,
            PlusSquare: () => <LucideIcon name="plus-square" className="w-5 h-5" />,
            MinusSquare: () => <LucideIcon name="minus-square" className="w-5 h-5" />,
            Lock: ({ className }) => <LucideIcon name="lock" className={className || "w-5 h-5"} />,
            Unlock: ({ className }) => <LucideIcon name="unlock" className={className || "w-5 h-5"} />,
            Video: () => <LucideIcon name="video" className="w-5 h-5" />,
            Square: () => <LucideIcon name="square" className="w-5 h-5" />,
            BarChart2: () => <LucideIcon name="bar-chart-2" className="w-5 h-5" />,
            XCircle: () => <LucideIcon name="x-circle" className="w-5 h-5" />,
            UploadCloud: () => <LucideIcon name="upload-cloud" className="w-12 h-12" />,
            Save: () => <LucideIcon name="save" className="w-4 h-4" />,
            TriangleAlert: () => <LucideIcon name="triangle-alert" className="w-6 h-6" />
        };
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error('ErrorBoundary caught:', error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-red-600 bg-white min-h-screen">
                            <h1 className="text-3xl font-bold mb-4">Something went wrong.</h1>
                            <div className="bg-red-50 p-6 rounded-lg border border-red-200 shadow-sm">
                                <h2 className="font-bold text-lg mb-2">Error Details:</h2>
                                <pre className="whitespace-pre-wrap font-mono text-sm">{this.state.error?.toString()}</pre>
                                <p className="mt-4 text-sm text-gray-600">Check the console for more details.</p>
                            </div>
                            <button onClick={() => window.location.reload()} className="mt-6 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">reload Page</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // LOGIN
        const LoginScreen = ({ onLogin }) => {
            const [role, setRole] = useState('admin');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                if (role === 'admin' && username === 'admin' && password === 'admin') {
                    onLogin({ role: 'admin', name: 'Administrator' });
                } else if (role === 'student') {
                    const student = window.Utils.authenticateStudent(username, password);
                    if (student) onLogin({ role: 'student', ...student });
                    else setError('Invalid student credentials');
                } else if (role === 'assessor') {
                    const batch = window.Utils.authenticateAssessor(username, password);
                    if (batch) onLogin({ role: 'assessor', name: 'Assessor', batchId: batch.id });
                    else setError('Invalid assessor credentials');
                } else setError('Invalid credentials');
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md glass">
                        <h1 className="text-3xl font-bold text-center text-gray-800 mb-2">NSXpertise</h1>
                        <p className="text-center text-gray-500 mb-8">Assessment Management System</p>
                        <div className="flex justify-center gap-4 mb-6">
                            {['admin', 'student', 'assessor'].map(r => (
                                <button key={r} onClick={() => setRole(r)}
                                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${role === r ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                        }`}>
                                    {r.charAt(0).toUpperCase() + r.slice(1)}
                                </button>
                            ))}
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" required className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                    value={username} onChange={e => setUsername(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" required className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                    value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded">{error}</p>}
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transform hover:scale-[1.02] transition-all">
                                Login as {role.charAt(0).toUpperCase() + role.slice(1)}
                            </button>
                            <div className="text-center text-xs text-gray-400 mt-4"><p>Demo: admin/admin</p></div>
                        </form>
                    </div>
                </div>
            );
        };

        // SIDEBAR COMPONENT
        const Sidebar = ({ activeTab, setActiveTab }) => {
            const [isQpsOpen, setIsQpsOpen] = useState(true);

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: <Icons.Grid /> },
                { id: 'calendar', label: 'Calendar', icon: <Icons.Calendar /> }, // Placeholder
                { id: 'location', label: 'Assessment Location', icon: <Icons.MapPin /> }, // Placeholder
                { id: 'subjects', label: 'Sector Skill Councils', icon: <Icons.Layers /> },
            ];

            return (
                <div className="w-64 bg-slate-800 text-white min-h-screen flex flex-col">
                    <div className="p-6 border-b border-slate-700">
                        <h1 className="text-xl font-bold">NSXpertise</h1>
                    </div>
                    <nav className="flex-1 p-4 space-y-1">
                        {menuItems.map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
                                {item.icon}
                                <span className="text-sm font-medium">{item.label}</span>
                            </button>
                        ))}

                        {/* QPS & NOS Dropdown */}
                        <div className="space-y-1">
                            <button onClick={() => setIsQpsOpen(!isQpsOpen)}
                                className={`w-full flex items-center justify-between px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors`}>
                                <div className="flex items-center gap-3">
                                    <Icons.Book />
                                    <span className="text-sm font-medium">QPS & NOS</span>
                                </div>
                                {isQpsOpen ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
                            </button>

                            {isQpsOpen && (
                                <div className="pl-12 space-y-1">
                                    <button onClick={() => setActiveTab('qps')}
                                        className={`w-full text-left px-4 py-2 rounded-lg text-sm transition-colors ${activeTab === 'qps' ? 'text-white font-medium' : 'text-slate-400 hover:text-white'}`}>
                                        Qualification Pack
                                    </button>
                                    <button onClick={() => setActiveTab('nos')}
                                        className={`w-full text-left px-4 py-2 rounded-lg text-sm transition-colors ${activeTab === 'nos' ? 'text-white font-medium' : 'text-slate-400 hover:text-white'}`}>
                                        NOS & PC
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Legacy Tabs moved to bottom or hidden if unused, keeping for now as direct links */}
                        <div className="pt-4 mt-4 border-t border-slate-700">
                            <p className="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Assessment</p>
                            <button onClick={() => setActiveTab('questionPapers')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'questionPapers' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.FileText /> <span className="text-sm">Question Papers</span>
                            </button>
                            <button onClick={() => setActiveTab('batches')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'batches' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.Users /> <span className="text-sm">Batches</span>
                            </button>
                            <button onClick={() => setActiveTab('results')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'results' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.Cpu /> <span className="text-sm">Results</span>
                            </button>
                        </div>

                    </nav>
                </div>
            );
        };



        // SUBJECTS TAB
        const SubjectsTab = () => {
            const [sscList, setSSCList] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newSSC, setNewSSC] = useState({ name: '', code: '' });

            useEffect(() => setSSCList(window.Utils.getSSC()), []);

            const handleCreate = (e) => {
                e.preventDefault();
                const ssc = { ...newSSC, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveSSC(ssc);
                setSSCList(window.Utils.getSSC());
                setShowModal(false);
                setNewSSC({ name: '', code: '' });
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold">Sector Skill Councils (SSC)</h3>
                        <button onClick={() => setShowModal(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700">
                            <Icons.Plus /> Add SSC
                        </button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 text-left font-bold text-gray-600">#</th>
                                    <th className="p-4 text-left font-bold text-gray-600">Name</th>
                                    <th className="p-4 text-left font-bold text-gray-600">Code</th>
                                    <th className="p-4 text-center font-bold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {sscList.map((ssc, idx) => (
                                    <tr key={ssc.id} className="hover:bg-gray-50">
                                        <td className="p-4">{idx + 1}</td>
                                        <td className="p-4 font-medium">{ssc.name}</td>
                                        <td className="p-4">{ssc.code}</td>
                                        <td className="p-4 text-center">
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteSSC(ssc.id); setSSCList(window.Utils.getSSC()); } }}
                                                className="text-red-600 hover:text-red-800"><Icons.Trash2 /></button>
                                        </td>
                                    </tr>
                                ))}
                                {sscList.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">No SSCs found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-xl font-bold mb-4">Add New SSC</h3>
                                <form onSubmit={handleCreate} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Name</label>
                                        <input type="text" required className="w-full px-4 py-2 border rounded-lg"
                                            value={newSSC.name} onChange={e => setNewSSC({ ...newSSC, name: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Code</label>
                                        <input type="text" required className="w-full px-4 py-2 border rounded-lg"
                                            value={newSSC.code} onChange={e => setNewSSC({ ...newSSC, code: e.target.value })} />
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                                        <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // UPLOAD NOS & PC COMPONENT
        const UploadNOSPC = ({ onBack, selectedSSC, sscList }) => {
            const [file, setFile] = useState(null);

            const downloadSample = () => {
                const ws = XLSX.utils.aoa_to_sheet([
                    ["QualificationPackID", "NOSID", "NOSName", "PC No", "PC Name", "Theory Marks", "Practical Marks", "Viva Marks", "Total Marks"],
                    ["QP001", "NOS001", "Intro to Farming", "PC1", "Identify seeds", "10", "20", "5", "35"]
                ]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, "NOS_PC_Sample.xlsx");
            };

            const handleValidate = () => {
                if (!file) return alert("Please select a file");
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);

                        const qps = window.Utils.getQPs();
                        let currentNOS = window.Utils.getNOS();
                        let currentPCs = window.Utils.getPCs();

                        let addedNOS = 0;
                        let addedPCs = 0;
                        let errors = [];

                        json.forEach((row, idx) => {
                            const r = idx + 2;
                            const qpCode = row['QualificationPackID'];
                            const nosCode = row['NOSID'];

                            if (!qpCode) return;

                            const qp = qps.find(q => q.code === String(qpCode));
                            if (!qp) {
                                const msg = `Row ${r}: QP '${qpCode}' not found`;
                                if (!errors.includes(msg)) errors.push(msg);
                                return;
                            }

                            if (nosCode) {
                                let nos = currentNOS.find(n => n.code === String(nosCode) && n.qpId === qp.id);
                                if (!nos) {
                                    nos = {
                                        id: window.Utils.generateId(),
                                        qpId: qp.id,
                                        code: String(nosCode),
                                        name: row['NOSName'] || nosCode,
                                        createdAt: new Date().toISOString()
                                    };
                                    currentNOS.push(nos);
                                    window.Utils.saveNOS(nos);
                                    addedNOS++;
                                }

                                const pcCode = row['PC No'];
                                if (pcCode) {
                                    const exists = currentPCs.find(p => p.nosId === nos.id && p.code === String(pcCode));
                                    if (!exists) {
                                        const pc = {
                                            id: window.Utils.generateId(),
                                            nosId: nos.id,
                                            code: String(pcCode),
                                            name: row['PC Name'] || pcCode,
                                            theoryMarks: row['Theory Marks'] || 0,
                                            practicalMarks: row['Practical Marks'] || 0,
                                            vivaMarks: row['Viva Marks'] || 0,
                                            totalMarks: row['Total Marks'] || 0
                                        };
                                        currentPCs.push(pc);
                                        window.Utils.savePC(pc);
                                        addedPCs++;
                                    }
                                }
                            }
                        });

                        if (errors.length > 0) {
                            alert(`Imported with warnings:\nAdded ${addedNOS} NOS, ${addedPCs} PCs.\nErrors:\n${errors.slice(0, 10).join('\n')}`);
                        } else {
                            alert(`Success! Imported ${addedNOS} NOS and ${addedPCs} PCs.`);
                        }
                        if (addedNOS > 0 || addedPCs > 0) onBack();

                    } catch (err) {
                        alert("Error parsing file: " + err.message);
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="animate-fade-in text-sm">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold text-gray-800">Upload NOS & PC</h2>
                        <button onClick={onBack} className="bg-white border hover:bg-gray-50 text-gray-700 px-4 py-2 rounded shadow-sm">Back</button>
                    </div>

                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div className="flex items-center gap-8 mb-8">
                            <span className="font-bold text-gray-700">Sector Skill Council :</span>
                            <span className="text-gray-600 font-medium text-lg">{sscList.find(s => s.id === selectedSSC)?.name || 'All'}</span>
                        </div>

                        <div className="space-y-4 mb-8">
                            <p className="font-medium text-gray-600">Note : It will accept only Excel files with *.xls or *.xlsx extension only.</p>
                            <div className="flex items-center gap-4">
                                <button onClick={downloadSample} className="flex items-center gap-2 text-green-600 border border-green-600 px-4 py-2 rounded hover:bg-green-50">
                                    <Icons.Download className="w-4 h-4" /> Download Sample Format
                                </button>
                            </div>
                        </div>

                        <div className="border-t pt-8">
                            <div className="max-w-xl mx-auto text-center">
                                <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 hover:border-indigo-500 transition-colors">
                                    <Icons.Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                                    <p className="text-gray-600 mb-4">Drag and drop your Excel file here, or click to browse</p>
                                    <input type="file" accept=".xlsx,.xls" onChange={e => setFile(e.target.files[0])} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                                </div>
                                <button onClick={handleValidate} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-md">
                                    Upload & Process
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // QPs STRUCTURE TAB
        const QPsTab = ({ onNavigateToNOS }) => {
            const [qpList, setQPList] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [selectedSSC, setSelectedSSC] = useState('');
            const [showModal, setShowModal] = useState(false);
            const [viewMode, setViewMode] = useState('list'); // 'list' | 'upload'

            // Enhanced QP State
            const [newQP, setNewQP] = useState({
                sscId: '', name: '', code: '', qpLevel: '',
                theoryMarks: '', vivaMarks: '', practicalMarks: '', totalMarks: '',
                theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: '',
                isTheoryCutoff: false, isVivaCutoff: false, isPracticalCutoff: false, isOverallCutoff: false
            });

            useEffect(() => {
                setQPList(window.Utils.getQPs());
                setSSCList(window.Utils.getSSC());
            }, []);

            // Auto-calculate Total Marks
            useEffect(() => {
                const total = (parseFloat(newQP.theoryMarks) || 0) + (parseFloat(newQP.vivaMarks) || 0) + (parseFloat(newQP.practicalMarks) || 0);
                setNewQP(prev => ({ ...prev, totalMarks: total || '' }));
            }, [newQP.theoryMarks, newQP.vivaMarks, newQP.practicalMarks]);

            const handleCreate = (e) => {
                e.preventDefault();
                const qp = { ...newQP, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveQP(qp);
                setQPList(window.Utils.getQPs());
                setShowModal(false);
                setNewQP({
                    sscId: '', name: '', code: '', qpLevel: '',
                    theoryMarks: '', vivaMarks: '', practicalMarks: '', totalMarks: '',
                    isTheoryCutoff: false, isVivaCutoff: false, isPracticalCutoff: false, isOverallCutoff: false
                });
            };

            const filteredQPs = selectedSSC ? qpList.filter(q => q.sscId === selectedSSC) : qpList;
            const getSSCName = (id) => sscList.find(s => s.id === id)?.name || id;

            if (viewMode === 'upload') {
                return <UploadNOSPC onBack={() => setViewMode('list')} selectedSSC={selectedSSC} sscList={sscList} />;
            }

            return (
                <div className="animate-fade-in text-sm">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Qualification Packs</h2>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-4 w-1/3">
                                <label className="text-sm font-bold text-gray-700 whitespace-nowrap">Sector Skill Council:</label>
                                <select className="w-full p-2 border rounded-md bg-gray-50" value={selectedSSC} onChange={e => setSelectedSSC(e.target.value)}>
                                    <option value="">Select SSC</option>
                                    {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-2 text-gray-600 font-medium mr-4">
                                    <Icons.Book />
                                    <span>Total Records : {filteredQPs.length}</span>
                                </div>
                                <button className="bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-gray-700">
                                    Export To <Icons.ChevronDown />
                                </button>
                                <button onClick={() => setShowModal(true)} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600">
                                    <Icons.Plus /> Add New
                                </button>
                                <button onClick={() => setViewMode('upload')} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600">
                                    <Icons.Upload /> Upload NOS & PC
                                </button>
                            </div>
                        </div>
                    </div>



                    <div className="bg-white rounded shadow border overflow-x-auto">
                        <table className="w-full min-w-[1200px]">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Qualification Pack ID</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Name</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Level</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Theory Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Practical Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Viva Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Theory Cutoff</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Practical Cutoff</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Viva Cutoff</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Overall Cutoff</th>
                                    <th className="p-3 text-center font-bold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filteredQPs.map((qp) => (
                                    <tr key={qp.id} className="hover:bg-gray-50">
                                        <td className="p-3 font-bold text-red-500 border-r">{qp.code}</td>
                                        <td className="p-3 border-r max-w-xs truncate" title={qp.name}>{qp.name}</td>
                                        <td className="p-3 border-r">{qp.qpLevel || 'N/A'}</td>
                                        <td className="p-3 border-r">{Number(qp.totalMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{Number(qp.theoryMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{Number(qp.practicalMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{Number(qp.vivaMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{qp.isTheoryCutoff ? (qp.theoryCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 border-r">{qp.isPracticalCutoff ? (qp.practicalCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 border-r">{qp.isVivaCutoff ? (qp.vivaCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 border-r">{qp.isOverallCutoff ? (qp.overallCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 text-center flex justify-center gap-2">
                                            <button onClick={() => onNavigateToNOS(qp)} className="bg-cyan-700 text-white px-3 py-1 rounded text-xs flex items-center gap-1 hover:bg-cyan-800">
                                                <Icons.Eye /> NOS
                                            </button>
                                            <button className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800">
                                                <Icons.Edit3 />
                                            </button>
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteQP(qp.id); setQPList(window.Utils.getQPs()); } }}
                                                className="text-red-600 p-1 hover:bg-red-50 rounded"><Icons.Trash2 /></button>
                                        </td>
                                    </tr>
                                ))}
                                {filteredQPs.length === 0 && <tr><td colSpan="12" className="p-8 text-center text-gray-400">No records found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-xl p-8 w-full max-w-4xl my-8">
                                <h3 className="text-2xl font-bold mb-6 text-gray-800">Add Qualification Pack</h3>
                                <form onSubmit={handleCreate} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

                                        {/* Row 1 */}
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">SSC</label>
                                            <select required className="w-full px-4 py-2 border rounded-lg" value={newQP.sscId} onChange={e => setNewQP({ ...newQP, sscId: e.target.value })}>
                                                <option value="">Select SSC</option>
                                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Qualification Pack Name</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newQP.name} onChange={e => setNewQP({ ...newQP, name: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Qualification Pack ID</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newQP.code} onChange={e => setNewQP({ ...newQP, code: e.target.value })} />
                                        </div>

                                        {/* Row 2 */}
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Qualification Pack Level</label>
                                            <input className="w-full px-4 py-2 border rounded-lg" value={newQP.qpLevel} onChange={e => setNewQP({ ...newQP, qpLevel: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Theory Marks</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.theoryMarks} onChange={e => setNewQP({ ...newQP, theoryMarks: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Viva Marks</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.vivaMarks} onChange={e => setNewQP({ ...newQP, vivaMarks: e.target.value })} />
                                        </div>

                                        {/* Row 3 */}
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Practical Marks</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.practicalMarks} onChange={e => setNewQP({ ...newQP, practicalMarks: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Marks</label>
                                            <input readOnly className="w-full px-4 py-2 border rounded-lg bg-gray-100" value={newQP.totalMarks} />
                                        </div>
                                    </div>

                                    {/* Checkboxes */}
                                    <div className="space-y-4 pt-4 border-t">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isTheoryCutoff} onChange={e => setNewQP({ ...newQP, isTheoryCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is theory cutoff available</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isVivaCutoff} onChange={e => setNewQP({ ...newQP, isVivaCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is Viva cutoff available</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isPracticalCutoff} onChange={e => setNewQP({ ...newQP, isPracticalCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is practical cutoff available</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isOverallCutoff} onChange={e => setNewQP({ ...newQP, isOverallCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is overall cutoff available</span>
                                        </label>
                                    </div>

                                    <div className="flex gap-4 justify-end pt-6 border-t">
                                        <button type="button" onClick={() => setShowModal(false)} className="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium border border-gray-300">Cancel</button>
                                        <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium shadow-md">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // NOS & PC TAB
        const NOSPC_Tab = ({ selectedQP, onBack }) => {
            const [nosList, setNOSList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [pcList, setPCList] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [showNOSModal, setShowNOSModal] = useState(false);
            const [showPCModal, setShowPCModal] = useState(false);
            const [selectedNOS, setSelectedNOS] = useState(null);
            const [expandedNOS, setExpandedNOS] = useState([]);

            const [newNOS, setNewNOS] = useState({
                name: '', code: '', qpId: selectedQP?.id || '',
                theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: ''
            });
            const [newPC, setNewPC] = useState({ name: '', code: '' });

            useEffect(() => {
                setNOSList(window.Utils.getNOS());
                setQPList(window.Utils.getQPs());
                setPCList(window.Utils.getPCs());
                setSSCList(window.Utils.getSSC());
            }, []);

            const handleCreateNOS = (e) => {
                e.preventDefault();
                const nos = { ...newNOS, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveNOS(nos);
                setNOSList(window.Utils.getNOS());
                setShowNOSModal(false);
                setNewNOS({ name: '', code: '', qpId: selectedQP?.id || '', theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: '' });
            };

            const handleCreatePC = (e) => {
                e.preventDefault();
                if (!selectedNOS) return;
                const pc = {
                    ...newPC,
                    id: window.Utils.generateId(),
                    nosId: selectedNOS.id,
                    createdAt: new Date().toISOString(),
                    theoryMarks: 0, practicalMarks: 0, vivaMarks: 0, totalMarks: 0
                };
                window.Utils.savePC(pc);
                setPCList(window.Utils.getPCs());
                setShowPCModal(false);
                setNewPC({ name: '', code: '' });
            };

            const openPCModal = (nos) => {
                setSelectedNOS(nos);
                setShowPCModal(true);
            };

            const toggleExpand = (nosId) => {
                setExpandedNOS(prev => prev.includes(nosId) ? prev.filter(id => id !== nosId) : [...prev, nosId]);
            };

            const handlePCMarkChange = (pcId, field, value) => {
                const updatedPCs = pcList.map(pc => {
                    if (pc.id === pcId) {
                        const updatedPC = { ...pc, [field]: parseFloat(value) || 0 };
                        updatedPC.totalMarks = (updatedPC.theoryMarks || 0) + (updatedPC.practicalMarks || 0) + (updatedPC.vivaMarks || 0);
                        // Removed auto-save: window.Utils.savePC(updatedPC);
                        return updatedPC;
                    }
                    return pc;
                });
                setPCList(updatedPCs);
            };

            const handleSavePC = (pcId) => {
                const pcToSave = pcList.find(p => p.id === pcId);
                if (pcToSave) {
                    window.Utils.savePC(pcToSave);
                    alert("Marks saved successfully!");
                }
            };

            const getQPName = (id) => qpList.find(q => q.id === id)?.name || id;
            const getSSCName = (id) => sscList.find(s => s.id === id)?.name || id;

            const filteredNOS = selectedQP ? nosList.filter(n => n.qpId === selectedQP.id) : nosList;

            return (
                <div className="animate-fade-in text-sm">
                    {selectedQP ? (
                        <div className="mb-6">
                            <div className="flex justify-between items-start mb-6">
                                <h2 className="text-xl font-bold text-gray-800">Sector Skill Council : {getSSCName(selectedQP.sscId)}</h2>
                                <div className="text-right">
                                    <h2 className="text-xl font-bold text-gray-800">Qualification Pack : {selectedQP.name}</h2>
                                    <button onClick={onBack} className="mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium">← Back to QPs</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-3 bg-gray-50 p-4 rounded-lg border border-gray-100 text-sm font-medium text-gray-600">
                                <div>Total Theory Marks : {Number(selectedQP.theoryMarks).toFixed(2)}</div>
                                <div className="text-center">Total Practical Marks : {Number(selectedQP.practicalMarks).toFixed(2)}</div>
                                <div className="text-right">Total Viva Marks : {Number(selectedQP.vivaMarks).toFixed(2)}</div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">All NOS</h2>
                        </div>
                    )}

                    {!selectedQP && <div className="p-4 mb-4 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">Please select a Qualification Pack to view NOS details.</div>}

                    {selectedQP && (
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-12 text-center">Sr.#</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-10"></th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-32">NOS ID</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r">NOS</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Theory Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Practical Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Viva Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Overall Cutoff</th>
                                        <th className="p-3 text-center font-bold text-gray-600 w-48">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredNOS.map((nos, idx) => (
                                        <React.Fragment key={nos.id}>
                                            <tr className="hover:bg-gray-50">
                                                <td className="p-3 border-r text-center">{idx + 1}</td>
                                                <td className="p-3 border-r text-center">
                                                    <button onClick={() => toggleExpand(nos.id)} className="text-gray-500 hover:text-indigo-600">
                                                        {expandedNOS.includes(nos.id) ? <Icons.MinusSquare /> : <Icons.PlusSquare />}
                                                    </button>
                                                </td>
                                                <td className="p-3 font-bold text-green-600 border-r">{nos.code}</td>
                                                <td className="p-3 border-r">{nos.name}</td>
                                                <td className="p-3 border-r">{nos.theoryCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.practicalCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.vivaCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.overallCutoff || '0.00'}</td>
                                                <td className="p-3 text-center flex justify-center gap-2">
                                                    <button className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800">
                                                        <Icons.Edit3 className="w-4 h-4" />
                                                    </button>
                                                    <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteNOS(nos.id); setNOSList(window.Utils.getNOS()); } }}
                                                        className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    <button onClick={() => openPCModal(nos)} className="bg-red-500 text-white px-3 py-1 rounded flex items-center gap-1 hover:bg-red-600 text-xs font-bold">
                                                        <Icons.Plus className="w-3 h-3" /> PC's
                                                    </button>
                                                </td>
                                            </tr>
                                            {expandedNOS.includes(nos.id) && (
                                                <tr className="bg-gray-50/50">
                                                    <td colSpan="9" className="p-4 pl-12">
                                                        <div className="bg-white border rounded-lg overflow-hidden shadow-sm">
                                                            <table className="w-full text-sm">
                                                                <thead className="bg-gray-100 border-b">
                                                                    <tr>
                                                                        <th className="p-3 border-r w-12 text-center">Sr.#</th>
                                                                        <th className="p-3 border-r w-32 font-bold text-blue-600">PC ID</th>
                                                                        <th className="p-3 border-r">PC Name</th>
                                                                        <th className="p-3 border-r w-24">Total Marks</th>
                                                                        <th className="p-3 border-r w-32">Theory Marks</th>
                                                                        <th className="p-3 border-r w-32">Practical Marks</th>
                                                                        <th className="p-3 border-r w-32">Viva Marks</th>
                                                                        <th className="p-3 text-center w-24">Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y">
                                                                    {pcList.filter(p => p.nosId === nos.id).map((pc, pcIdx) => (
                                                                        <tr key={pc.id}>
                                                                            <td className="p-3 border-r text-center">{pcIdx + 1}</td>
                                                                            <td className="p-3 border-r font-bold text-blue-600">{pc.code}</td>
                                                                            <td className="p-3 border-r">{pc.name}</td>
                                                                            <td className="p-3 border-r font-bold">{((parseFloat(pc.theoryMarks) || 0) + (parseFloat(pc.practicalMarks) || 0) + (parseFloat(pc.vivaMarks) || 0)).toFixed(2)}</td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.theoryMarks} onChange={e => handlePCMarkChange(pc.id, 'theoryMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.practicalMarks} onChange={e => handlePCMarkChange(pc.id, 'practicalMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.vivaMarks} onChange={e => handlePCMarkChange(pc.id, 'vivaMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 text-center flex justify-center gap-1">
                                                                                <button onClick={() => handleSavePC(pc.id)} className="bg-green-600 text-white p-1 rounded hover:bg-green-700" title="Save Marks"><Icons.Save className="w-3 h-3" /></button>
                                                                                <button className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800"><Icons.Edit3 className="w-3 h-3" /></button>
                                                                                <button onClick={() => { if (confirm('Delete PC?')) { window.Utils.deletePC(pc.id); setPCList(window.Utils.getPCs()); } }}
                                                                                    className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-3 h-3" /></button>
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                    <tr className="bg-gray-100 font-bold">
                                                                        <td colSpan="3" className="p-3 text-right border-r">Total :</td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + ((parseFloat(p.theoryMarks) || 0) + (parseFloat(p.practicalMarks) || 0) + (parseFloat(p.vivaMarks) || 0)), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.theoryMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.practicalMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.vivaMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                    {filteredNOS.length === 0 && <tr><td colSpan="9" className="p-8 text-center text-gray-400">No NOS found for this QP</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {selectedQP && (
                        <div className="mt-4 flex justify-end">
                            <button onClick={() => setShowNOSModal(true)} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600">
                                <Icons.Plus /> Add NOS
                            </button>
                        </div>
                    )}

                    {showNOSModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-xl p-8 w-full max-w-2xl">
                                <h3 className="text-xl font-bold mb-6">Add NOS</h3>
                                <form onSubmit={handleCreateNOS} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">NOS Name</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newNOS.name} onChange={e => setNewNOS({ ...newNOS, name: e.target.value })} />
                                        </div>
                                        <div className="col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">NOS ID</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newNOS.code} onChange={e => setNewNOS({ ...newNOS, code: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Theory Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.theoryCutoff} onChange={e => setNewNOS({ ...newNOS, theoryCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Practical Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.practicalCutoff} onChange={e => setNewNOS({ ...newNOS, practicalCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Viva Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.vivaCutoff} onChange={e => setNewNOS({ ...newNOS, vivaCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Overall Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.overallCutoff} onChange={e => setNewNOS({ ...newNOS, overallCutoff: e.target.value })} />
                                        </div>
                                    </div>
                                    <div className="flex gap-4 justify-end pt-4">
                                        <button type="button" onClick={() => setShowNOSModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                                        <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showPCModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-lg">
                                <h3 className="text-xl font-bold mb-2">Manage PCs</h3>
                                <p className="text-sm text-gray-500 mb-4">For NOS: <span className="font-bold">{selectedNOS?.name}</span></p>

                                <div className="max-h-60 overflow-y-auto mb-4 border rounded p-2">
                                    <table className="w-full text-left text-sm">
                                        <thead>
                                            <tr className="bg-gray-50">
                                                <th className="p-2 border-b">Code</th>
                                                <th className="p-2 border-b">PC Name</th>
                                                <th className="p-2 border-b w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {pcList.filter(p => p.nosId === selectedNOS?.id).map(pc => (
                                                <tr key={pc.id} className="border-b last:border-0 hover:bg-gray-50">
                                                    <td className="p-2 font-mono text-xs">{pc.code}</td>
                                                    <td className="p-2">{pc.name}</td>
                                                    <td className="p-2 text-center">
                                                        <button onClick={() => { window.Utils.deletePC(pc.id); setPCList(window.Utils.getPCs()); }} className="text-red-500 hover:text-red-700"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {pcList.filter(p => p.nosId === selectedNOS?.id).length === 0 && <p className="text-xs text-gray-400 text-center py-4">No PCs added yet</p>}
                                </div>

                                <form onSubmit={handleCreatePC} className="space-y-4 border-t pt-4">
                                    <div className="flex gap-4">
                                        <input placeholder="PC Code (e.g. PC1)" required className="w-1/3 px-4 py-2 border rounded-lg" value={newPC.code} onChange={e => setNewPC({ ...newPC, code: e.target.value })} />
                                        <input placeholder="PC Name" required className="flex-1 px-4 py-2 border rounded-lg" value={newPC.name} onChange={e => setNewPC({ ...newPC, name: e.target.value })} />
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button type="button" onClick={() => setShowPCModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Done</button>
                                        <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add PC</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // QUESTION PAPERS TAB
        // QUESTION PAPERS TAB
        const QuestionPapersTab = () => {

            const [qpList, setQPList] = useState([]);
            const [allQPs, setAllQPs] = useState([]); // Store all QPs for filtering
            const [showUploadModal, setShowUploadModal] = useState(false);
            const [qpName, setQPName] = useState('');
            const [selectedQP, setSelectedQP] = useState(null);

            // New State for Filters
            const [sscList, setSSCList] = useState([]);
            const [masterQPList, setMasterQPList] = useState([]); // List of defined QPs from QP Tab
            const [selectedSSC, setSelectedSSC] = useState('');
            const [filterQPId, setFilterQPId] = useState('');

            useEffect(() => {
                setAllQPs(window.Utils.getQuestionPapers());
                setQPList(window.Utils.getQuestionPapers());
                setSSCList(window.Utils.getSSC());
                setMasterQPList(window.Utils.getQPs());
            }, []);

            // Apply Filters
            useEffect(() => {
                let filtered = allQPs;
                // Note: Currently uploaded QPs don't have explicit SSC link unless we infer or add manual mapping.
                // Assuming "Qualification Pack" filter refers to the QP Definition from QP Tab.
                // We might need to match by name or add a field during upload. 
                // For now, if the user selects a QP from the dropdown, we filter the uploaded papers 
                // that match that QP ID or Name? 
                // The uploaded QP is independent currently. 
                // To make this functional as per mockup, we'll implement the UI. 
                // Real filtering would depend on data linkage. 
                // Let's filter by name match if possible or just show UI if no linkage exists.

                // If the intention is just to show the UI:
                // We will implement the UI. Filtering might be minimal if data is missing.

            }, [selectedSSC, filterQPId, allQPs]);

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    const questions = rows.map((row, idx) => {
                        const questionType = (row.QuestionTypeID || '').toString().toUpperCase();
                        const isCoding = questionType === 'CODING';
                        const noOfOptions = isCoding ? 0 : parseInt(row.Noofoptions || 4);

                        // Parse PCIDsWithMarks (e.g., "PC1:5,PC2:3")
                        const pcMapping = {};
                        let calculatedMarks = 0;
                        if (row.PCIDsWithMarks) {
                            row.PCIDsWithMarks.toString().split(',').forEach(item => {
                                const parts = item.split(':');
                                if (parts.length === 2) {
                                    const pcId = parts[0].trim();
                                    const marks = parseFloat(parts[1]);
                                    if (!isNaN(marks)) {
                                        pcMapping[pcId] = marks;
                                        calculatedMarks += marks;
                                    }
                                }
                            });
                        }
                        return {
                            id: window.Utils.generateId(),
                            question: row.Question || row.question || '',
                            questionType: questionType || 'MCQ',
                            options: isCoding ? [] : [row.Option1, row.Option2, row.Option3, row.Option4, row.Option5].filter((o, i) => i < noOfOptions && o),
                            correctAnswer: row.Solution || row.Answer || '',
                            totalMarks: calculatedMarks > 0 ? calculatedMarks : parseFloat(row.Marks || 1),
                            pcMapping: pcMapping
                        };
                    });

                    // Validation: Check Total Theory Marks
                    const currentQPDef = masterQPList.find(q => q.id === filterQPId);
                    if (currentQPDef) {
                        const uploadedTheoryMarks = questions.reduce((sum, q) => {
                            if (q.questionType !== 'VIVA') {
                                return sum + q.totalMarks;
                            }
                            return sum;
                        }, 0);
                        const theoryMismatch = Math.abs(uploadedTheoryMarks - parseFloat(currentQPDef.theoryMarks || 0)) > 0.1;
                        if (theoryMismatch) {
                            alert(`Error: Uploaded Theory Marks (${uploadedTheoryMarks}) do not match QP Theory Marks (${currentQPDef.theoryMarks}).`);
                            return;
                        }
                    }

                    const qp = {
                        id: window.Utils.generateId(),
                        qpName: qpName || 'Question Paper',
                        questions: questions,
                        totalMarks: questions.reduce((sum, q) => sum + q.totalMarks, 0),
                        totalTime: 60,
                        createdAt: new Date().toISOString(),
                        sscId: selectedSSC,
                        qpId: filterQPId
                    };
                    window.Utils.saveQuestionPaper(qp);
                    setQPList(window.Utils.getQuestionPapers());
                    setShowUploadModal(false);
                    setQPName('');
                    alert('Question Paper uploaded successfully!');
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="animate-fade-in text-sm">
                    <div className="mb-6">
                        <h3 className="text-xl font-bold mb-6 text-gray-800">Question Papers</h3>

                        <div className="bg-white p-6 rounded-xl border border-gray-200">
                            <div className="grid grid-cols-[auto_1fr] gap-y-4 gap-x-6 items-center max-w-2xl mb-6">
                                <label className="font-semibold text-gray-700 text-right">Select Sector :</label>
                                <select className="w-full p-2 border rounded-lg bg-white outline-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition-all"
                                    value={selectedSSC} onChange={e => setSelectedSSC(e.target.value)}>
                                    <option value="">Select Sector</option>
                                    {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>

                                <label className="font-semibold text-gray-700 text-right">Qualification Pack:</label>
                                <select className="w-full p-2 border rounded-lg bg-white outline-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition-all"
                                    value={filterQPId} onChange={e => setFilterQPId(e.target.value)}>
                                    <option value="">Select Qualification Pack</option>
                                    {masterQPList.filter(q => !selectedSSC || q.sscId === selectedSSC).map(q => (
                                        <option key={q.id} value={q.id}>{q.name}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="flex justify-end border-t pt-4">
                                <button onClick={() => setShowUploadModal(true)}
                                    className="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2">
                                    <Icons.Upload className="w-4 h-4" /> Upload Question Paper
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 font-bold text-gray-600 border-r w-16 text-center">Sr.#</th>
                                    <th className="p-4 font-bold text-gray-600 border-r">Details</th>
                                    <th className="p-4 font-bold text-gray-600 border-r">Sector / QP</th>
                                    <th className="p-4 font-bold text-gray-600 border-r w-32 text-center">Marks</th>
                                    <th className="p-4 font-bold text-gray-600 border-r w-32 text-center">Questions</th>
                                    <th className="p-4 font-bold text-gray-600 w-24 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {qpList.filter(q => (!selectedSSC || q.sscId === selectedSSC) && (!filterQPId || q.qpId === filterQPId)).map((qp, idx) => (
                                    <tr key={qp.id} className="hover:bg-gray-50 transition-colors">
                                        <td className="p-4 border-r text-center text-gray-500">{idx + 1}</td>
                                        <td className="p-4 border-r">
                                            <div className="font-bold text-gray-800">{qp.qpName}</div>
                                            <div className="text-xs text-gray-400 mt-1">{new Date(qp.createdAt).toLocaleDateString()}</div>
                                        </td>
                                        <td className="p-4 border-r">
                                            <div className="text-xs font-semibold text-gray-600 mb-1">{sscList.find(s => s.id === qp.sscId)?.name || '-'}</div>
                                            <div className="text-xs text-gray-500">{masterQPList.find(q => q.id === qp.qpId)?.name || '-'}</div>
                                        </td>
                                        <td className="p-4 border-r text-center font-medium text-gray-700">{qp.totalMarks}</td>
                                        <td className="p-4 border-r text-center font-medium text-gray-700">{qp.questions.length}</td>
                                        <td className="p-4 text-center">
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteQuestionPaper(qp.id); setQPList(window.Utils.getQuestionPapers()); } }}
                                                className="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-full transition-colors" title="Delete">
                                                <Icons.Trash2 className="w-4 h-4" />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {qpList.length === 0 && (
                                    <tr>
                                        <td colSpan="6" className="p-8 text-center text-gray-400">No question papers found.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    {showUploadModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-4xl my-8 shadow-2xl rounded-xl overflow-hidden animate-scale-in">
                                <div className="bg-gray-50 px-8 py-5 flex justify-between items-center border-b">
                                    <h3 className="text-xl font-bold text-gray-800">Upload Question Paper</h3>
                                    <button onClick={() => setShowUploadModal(false)} className="text-gray-400 hover:text-red-500 transition-colors">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="p-8 max-h-[80vh] overflow-y-auto">
                                    <div className="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 mb-8 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <div className="font-bold text-gray-700 text-right">Selected Sector:</div>
                                        <div className="text-gray-800">{sscList.find(s => s.id === selectedSSC)?.name || '-'}</div>
                                        <div className="font-bold text-gray-700 text-right">Selected QP:</div>
                                        <div className="text-gray-800">
                                            {masterQPList.find(q => q.id === filterQPId)?.name || '-'}
                                            <span className="text-xs text-gray-500 ml-2">(Total Marks: {masterQPList.find(q => q.id === filterQPId)?.totalMarks || 0}, Theory: {masterQPList.find(q => q.id === filterQPId)?.theoryMarks || 0})</span>
                                        </div>
                                    </div>

                                    <div className="mb-6 space-y-3">
                                        <p className="text-gray-600 text-sm">
                                            <span className="font-bold text-red-500">Note:</span> Only Excel files (*.xls, *.xlsx) are accepted.
                                        </p>
                                        <div className="flex items-center gap-2 text-sm">
                                            <span>Use the standard format:</span>
                                            <button className="text-green-600 font-medium hover:underline flex items-center gap-1">
                                                <Icons.Download className="w-4 h-4" /> Download Sample Format
                                            </button>
                                        </div>
                                    </div>

                                    <div className="border rounded-lg overflow-hidden mb-8 shadow-sm">
                                        <table className="w-full text-left text-xs">
                                            <thead className="bg-gray-100 text-gray-700">
                                                <tr>
                                                    {['Question', 'Option1', 'Option2', 'Option3', 'Option4', 'Solution', 'NoofOptions', 'QuestionTypeID', 'PCIDsWithMarks'].map(h => (
                                                        <th key={h} className="p-2 border-r last:border-r-0 font-bold">{h}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody className="text-gray-500">
                                                <tr>
                                                    <td className="p-2 border-r">Sample Question?</td>
                                                    <td className="p-2 border-r">A</td>
                                                    <td className="p-2 border-r">B</td>
                                                    <td className="p-2 border-r">C</td>
                                                    <td className="p-2 border-r">D</td>
                                                    <td className="p-2 border-r">Option1</td>
                                                    <td className="p-2 border-r">4</td>
                                                    <td className="p-2 border-r">MCQ</td>
                                                    <td className="p-2">PC1:5,PC2:3</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative">
                                        <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="pointer-events-none">
                                            <Icons.UploadCloud className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                                            <p className="font-medium text-gray-600">Drag & Drop or Click to Upload Excel File</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const BatchesTab = () => {

            const [batches, setBatches] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [filteredBatches, setFilteredBatches] = useState([]);

            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showAssignModal, setShowAssignModal] = useState(false);
            const [showStudentModal, setShowStudentModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);

            const [selectedBatch, setSelectedBatch] = useState(null);
            const [assignmentType, setAssignmentType] = useState('Theory');
            const [selectedAssignQP, setSelectedAssignQP] = useState('');

            // Hierarchy Filters for Assign Modal
            const [assignSSC, setAssignSSC] = useState('');
            const [assignQPDef, setAssignQPDef] = useState('');

            // Filters
            const [filterSSC, setFilterSSC] = useState('');
            const [filterQP, setFilterQP] = useState('');
            const [filterStartDate, setFilterStartDate] = useState('');

            const [filterEndDate, setFilterEndDate] = useState('');
            const [searchQuery, setSearchQuery] = useState('');

            // Enhanced Batch State
            const [newBatch, setNewBatch] = useState({
                name: '',
                project: '',
                trainingCentre: '',
                state: '',
                spocContactNo: '',
                centerAddress: '',
                startDate: '',
                endDate: '',
                loginRestrictCount: '3',
                modeOfAssessment: '',
                batchSize: '',
                centerId: '',
                district: '',
                spocEmail: '',
                tpName: '',
                startTime: '',
                endTime: '',
                captureImage: true,
                cameraInterval: '60'
            });

            const [showNewProjectInput, setShowNewProjectInput] = useState(false);

            // Mock Data for Dropdowns
            const projects = ['PMKVY', 'CMKVY', 'DDU-GKY', 'NULM', 'Corporate'];
            const trainingCentres = [
                { id: 'TC001', name: 'Alpha Tech Institute', state: 'Karnataka', district: 'Bangalore', centerId: 'C-BLR-01', address: '123 Tech Park, Bangalore', spoc: 'John Doe' },
                { id: 'TC002', name: 'Beta Skills Academy', state: 'Maharashtra', district: 'Pune', centerId: 'C-PUN-02', address: '456 Skill Ave, Pune', spoc: 'Jane Smith' },
                { id: 'TC003', name: 'Gamma Vocational Center', state: 'Delhi', district: 'New Delhi', centerId: 'C-DEL-03', address: '789 Edu Road, Delhi', spoc: 'Robert Brown' }
            ];

            const assessmentModes = ['Online', 'Offline', 'Hybrid'];

            useEffect(() => {
                const b = window.Utils.getBatches();
                setBatches(b);
                setFilteredBatches(b);
                setSSCList(window.Utils.getSSC());
                setQPList(window.Utils.getQPs());
            }, []);

            const handleSearch = () => {
                let result = batches;
                if (searchQuery) {
                    result = result.filter(b => b.name.toLowerCase().includes(searchQuery.toLowerCase()));
                }
                if (filterQP) {
                    result = result.filter(b => b.theoryPaperId === filterQP || b.practicalPaperId === filterQP);
                }
                setFilteredBatches(result);
            };

            const handleTCSelection = (e) => {
                const tcName = e.target.value;
                const tc = trainingCentres.find(t => t.name === tcName);
                if (tc) {
                    setNewBatch({
                        ...newBatch,
                        trainingCentre: tcName,
                        state: tc.state,
                        district: tc.district, // Display only
                        centerId: tc.centerId, // Display only
                        centerAddress: tc.address,
                        spocName: tc.spoc
                    });
                } else {
                    setNewBatch({ ...newBatch, trainingCentre: tcName });
                }
            };

            const handleCreateBatch = (e) => {
                e.preventDefault();
                const batch = {
                    ...newBatch,
                    id: window.Utils.generateId(),
                    assessorUsername: 'assessor_' + Math.random().toString(36).substr(2, 5),
                    assessorPassword: Math.random().toString(36).substr(2, 6),
                    createdAt: new Date().toISOString()
                };
                window.Utils.saveBatch(batch);
                const updated = window.Utils.getBatches();
                setBatches(updated);
                setFilteredBatches(updated);
                setShowCreateModal(false);
                setNewBatch({
                    name: '', project: '', trainingCentre: '', state: '', spocContactNo: '', centerAddress: '',
                    startDate: '', endDate: '', loginRestrictCount: '3', modeOfAssessment: '',
                    batchSize: '', centerId: '', district: '', spocEmail: '', tpName: '', startTime: '', endTime: '',
                    captureImage: true, cameraInterval: '60'
                });
            };

            const handleAssignQP = () => {
                if (!selectedBatch || !selectedAssignQP) return;
                const updatedBatches = batches.map(b => {
                    if (b.id === selectedBatch.id) {
                        return { ...b, [assignmentType === 'Practical' ? 'practicalPaperId' : 'theoryPaperId']: selectedAssignQP };
                    }
                    return b;
                });
                window.Utils.updateBatches(updatedBatches);
                setBatches(updatedBatches);
                setFilteredBatches(updatedBatches);
                setShowAssignModal(false);
                setSelectedBatch(null);
                setSelectedAssignQP('');
            };

            const handleStudentUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !selectedBatch) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    let count = 0;
                    const existingStudents = window.Utils.getStudentsByBatch(selectedBatch.id);
                    let currentCount = existingStudents.length;

                    // DEBUG: Show detected keys
                    if (rows.length > 0) {
                        alert("Debug: Detected Excel Columns: " + Object.keys(rows[0]).join(", "));
                    }

                    rows.forEach(row => {
                        // Flexible matching for keys
                        const enrollmentNo = row['Enrollment No'] || row['EnrollmentNo'];
                        const studentName = row['Name of the Trainee'] || row['Trainee Name'] || row['Name'] || row['Student Name'] || row['StudentName'] || row['Candidate Name'] || row['CandidateName'] || row['Full Name'] || row['FullName'] || row['Trainee'];

                        if (studentName) {
                            const sequence = 100 + currentCount;

                            // Auto-increment name if it is just "U"
                            let finalName = studentName;
                            if (studentName.trim().toUpperCase() === 'U') {
                                finalName = `U${currentCount + 1}`;
                            }

                            const student = {
                                id: window.Utils.generateId(),
                                name: finalName,
                                username: sequence.toString(), // Sequential username: 100, 101...
                                enrollmentNo: enrollmentNo ? enrollmentNo.toString() : '',
                                password: enrollmentNo ? enrollmentNo.toString() : 'password',
                                batchId: selectedBatch.id,
                                role: 'student'
                            };
                            window.Utils.saveStudent(student);
                            currentCount++;
                            count++;
                        }
                    });

                    alert(`Uploaded ${count} students to ${selectedBatch.name}`);
                    setShowStudentModal(false);
                    // Force refresh by toggling selection or updating state if needed
                    // But setShowStudentModal(false) closes it, so next open will get fresh data.
                    setSelectedBatch(null);
                };
                reader.readAsArrayBuffer(file);
            };

            // NEW: Bulk Import with Batch Name Mapping
            const handleBulkStudentImport = (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('bulkImportFile');
                const file = fileInput?.files[0];
                if (!file) { alert("Please select a file first."); return; }

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet); // [{BatchName: '...', Enrollment No: '...', ...}]

                    let addedCount = 0;
                    let errors = [];

                    // Get fresh batch list to ensure we match correctly
                    const currentBatches = window.Utils.getBatches();

                    // Pre-fetch student counts for involved batches to maintain sequence
                    const batchCounts = {};

                    rows.forEach((row, index) => {
                        // Expected keys: "BatchName", "Enrollment No", "Name of the Trainee"
                        // Flexible matching for keys
                        const batchName = row['BatchName'] || row['Batch Name'];
                        const enrollmentNo = row['Enrollment No'] || row['EnrollmentNo'];
                        const studentName = row['Name of the Trainee'] || row['Trainee Name'] || row['Name'] || row['Student Name'] || row['StudentName'] || row['Candidate Name'] || row['CandidateName'] || row['Full Name'] || row['FullName'] || row['Trainee'];

                        // Debug log to identify column issues
                        if (!studentName || studentName === 'U') console.log('Row detection:', row);

                        if (!batchName) {
                            errors.push(`Row ${index + 2}: Missing Batch Name`);
                            return;
                        }

                        // Find batch
                        const targetBatch = currentBatches.find(b => b.name.trim().toLowerCase() === batchName.toString().trim().toLowerCase());

                        if (!targetBatch) {
                            errors.push(`Row ${index + 2}: Batch "${batchName}" not found`);
                            return;
                        }

                        if (!studentName) {
                            errors.push(`Row ${index + 2}: Missing Student Name`);
                            return;
                        }

                        // Initialize count for this batch if not done yet
                        if (batchCounts[targetBatch.id] === undefined) {
                            batchCounts[targetBatch.id] = window.Utils.getStudentsByBatch(targetBatch.id).length;
                        }

                        const sequence = 100 + batchCounts[targetBatch.id];

                        // Auto-increment name if it is just "U"
                        let finalName = studentName;
                        if (studentName.trim().toUpperCase() === 'U') {
                            finalName = `U${batchCounts[targetBatch.id] + 1}`;
                        }

                        const student = {
                            id: window.Utils.generateId(),
                            name: finalName, // Use the auto-incremented name
                            username: sequence.toString(), // Sequential username: 100, 101...
                            enrollmentNo: enrollmentNo ? enrollmentNo.toString() : '', // Save Excel Enrollment No separately
                            password: enrollmentNo ? enrollmentNo.toString() : 'password', // Password is Enrollment No
                            batchId: targetBatch.id,
                            role: 'student'
                        };
                        window.Utils.saveStudent(student);

                        batchCounts[targetBatch.id]++; // Increment local count
                        addedCount++;
                    });

                    let msg = `Successfully uploaded ${addedCount} students across batches.`;
                    if (errors.length > 0) {
                        msg += `\n\nErrors:\n` + errors.slice(0, 10).join('\n') + (errors.length > 10 ? '\n...' : '');
                    }
                    alert(msg);
                    setShowImportModal(false);
                };
                reader.readAsArrayBuffer(file);
            };

            const questionPapers = window.Utils.getQuestionPapers();
            const getQPName = (id) => questionPapers.find(q => q.id === id)?.qpName || '-';

            return (
                <div className="animate-fade-in text-sm">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Add / View Batches</h2>

                    {/* Filters */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-gray-700">Sector Skill Council :</label>
                            <select className="w-full p-2 border rounded-md bg-gray-50 text-sm" value={filterSSC} onChange={e => setFilterSSC(e.target.value)}>
                                <option value="">Select SSC</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-gray-700">Qualification Pack :</label>
                            <select className="w-full p-2 border rounded-md bg-gray-50 text-sm" value={filterQP} onChange={e => setFilterQP(e.target.value)}>
                                <option value="">Select QP</option>
                                {qpList.map(q => <option key={q.id} value={q.id}>{q.name} ({q.code})</option>)}
                            </select>
                        </div>
                        <div className="flex items-end gap-2">
                            <div className="flex-1">
                                <input type="text" placeholder="Search with batch name" className="w-full p-2 border rounded-md" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                            </div>
                            <button onClick={handleSearch} className="bg-green-500 text-white px-4 py-2 rounded flex items-center gap-1 hover:bg-green-600">
                                <Icons.Grid className="w-4 h-4" /> Search
                            </button>
                        </div>
                        <div className="space-y-1">
                            <input type="date" className="w-full p-2 border rounded-md text-gray-500" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <input type="date" className="w-full p-2 border rounded-md text-gray-500" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} />
                        </div>
                        <div className="flex items-end">
                            <button onClick={handleSearch} className="bg-red-500 text-white px-6 py-2 rounded shadow hover:bg-red-600 font-medium">Search</button>
                        </div>
                    </div>

                    {/* Toolbar */}
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2 text-gray-700 font-medium">
                            <Icons.Book className="w-5 h-5 text-orange-500" />
                            <span>Total Records : {filteredBatches.length}</span>
                        </div>
                        <div className="flex gap-2">
                            <button className="bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-gray-700 text-xs shadow-sm shadow-gray-200 border border-gray-200/50">
                                Export To <Icons.ChevronDown className="w-3 h-3" />
                            </button>
                            <button onClick={() => setShowImportModal(true)} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600 text-xs shadow-md shadow-red-200">
                                <Icons.UserPlus className="w-4 h-4" /> Import Students
                            </button>
                            <button onClick={() => setShowCreateModal(true)} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600 text-xs shadow-md shadow-red-200">
                                <Icons.Plus className="w-4 h-4" /> Add New Batch
                            </button>
                        </div>
                    </div>

                    {/* Table */}
                    <div className="bg-white rounded-t-xl shadow-sm border border-gray-200 overflow-x-auto">
                        <table className="w-full min-w-[1200px]">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-12">Sr.#</th>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-32">Batch Name</th>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Center ID</th>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Total Students</th>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-32">Start Date</th>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-32">End Date</th>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-24">State</th>
                                    <th className="p-3 text-left font-bold text-gray-600 border-r w-24">District</th>
                                    <th className="p-3 text-center font-bold text-gray-600 border-r w-16">Edit</th>
                                    <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Students</th>
                                    <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Assessor</th>
                                    <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Theory QP</th>
                                    <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Viva QP</th>
                                    <th className="p-3 text-center font-bold text-gray-600 w-16">B</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filteredBatches.map((batch, idx) => (
                                    <tr key={batch.id} className="hover:bg-gray-50">
                                        <td className="p-3 border-r text-center">{idx + 1}</td>
                                        <td className="p-3 border-r font-medium text-gray-700">{batch.name}</td>
                                        <td className="p-3 border-r text-gray-600">{batch.centerId || '-'}</td>
                                        <td className="p-3 border-r text-center">
                                            {window.Utils.getStudentsByBatch(batch.id).length}
                                        </td>
                                        <td className="p-3 border-r text-xs text-gray-600">{batch.startDate ? new Date(batch.startDate).toLocaleString() : '-'}</td>
                                        <td className="p-3 border-r text-xs text-gray-600">{batch.endDate ? new Date(batch.endDate).toLocaleDateString() : '-'}</td>
                                        <td className="p-3 border-r text-gray-600">{batch.state || '-'}</td>
                                        <td className="p-3 border-r text-gray-600">{batch.district || '-'}</td>
                                        <td className="p-3 border-r text-center">
                                            <button className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Edit3 className="w-4 h-4" /></button>
                                        </td>
                                        <td className="p-3 border-r text-center">
                                            <button onClick={() => { setSelectedBatch(batch); setShowStudentModal(true); }}
                                                className="bg-cyan-700 text-white px-3 py-1 rounded flex items-center justify-center gap-1 hover:bg-cyan-800 text-xs mx-auto">
                                                <Icons.Eye className="w-3 h-3" /> View
                                            </button>
                                        </td>
                                        <td className="p-3 border-r text-center text-xs">
                                            <div title={`Pass: ${batch.assessorPassword}`}>{batch.assessorUsername}</div>
                                        </td>
                                        <td className="p-3 border-r text-center">
                                            {batch.theoryPaperId ? (
                                                <div className="flex items-center justify-center gap-1">
                                                    <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs">{getQPName(batch.theoryPaperId)}</span>
                                                    <button onClick={() => {
                                                        const qp = questionPapers.find(q => q.id === batch.theoryPaperId);
                                                        setSelectedBatch(batch); setAssignmentType('Theory'); setSelectedAssignQP(batch.theoryPaperId);
                                                        setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                        setShowAssignModal(true);
                                                    }} className="text-gray-500 hover:text-blue-600">
                                                        <Icons.Edit3 className="w-3 h-3" />
                                                    </button>
                                                </div>
                                            ) : (
                                                <button onClick={() => {
                                                    setSelectedBatch(batch); setAssignmentType('Theory'); setSelectedAssignQP('');
                                                    setAssignSSC(''); setAssignQPDef('');
                                                    setShowAssignModal(true);
                                                }} className="text-blue-600 underline text-xs">Assign</button>
                                            )}
                                        </td>
                                        <td className="p-3 border-r text-center">
                                            {batch.practicalPaperId ? (
                                                <div className="flex items-center justify-center gap-1">
                                                    <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs">{getQPName(batch.practicalPaperId)}</span>
                                                    <button onClick={() => {
                                                        const qp = questionPapers.find(q => q.id === batch.practicalPaperId);
                                                        setSelectedBatch(batch); setAssignmentType('Practical'); setSelectedAssignQP(batch.practicalPaperId);
                                                        setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                        setShowAssignModal(true);
                                                    }} className="text-gray-500 hover:text-blue-600">
                                                        <Icons.Edit3 className="w-3 h-3" />
                                                    </button>
                                                </div>
                                            ) : (
                                                <button onClick={() => {
                                                    setSelectedBatch(batch); setAssignmentType('Practical'); setSelectedAssignQP('');
                                                    setAssignSSC(''); setAssignQPDef('');
                                                    setShowAssignModal(true);
                                                }} className="text-blue-600 underline text-xs">Assign</button>
                                            )}
                                        </td>
                                        <td className="p-3 text-center">
                                            <button onClick={() => { if (confirm('Delete Batch?')) { window.Utils.deleteBatch(batch.id); setBatches(window.Utils.getBatches()); setFilteredBatches(window.Utils.getBatches()); } }}
                                                className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-4 h-4" /></button>
                                        </td>
                                    </tr>
                                ))}
                                {filteredBatches.length === 0 && <tr><td colSpan="14" className="p-8 text-center text-gray-400">No batches records found</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {/* New Import Students Modal */}
                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto font-sans">
                            <div className="bg-gray-100 w-full max-w-4xl my-8 shadow-xl rounded-lg overflow-hidden">
                                {/* Header */}
                                <div className="bg-gray-200 px-6 py-4 flex justify-between items-center border-b border-gray-300">
                                    <h3 className="text-xl font-bold text-gray-800">Import Students</h3>
                                    <button onClick={() => setShowImportModal(false)} className="text-gray-500 hover:text-gray-700">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="p-8 bg-white m-4 rounded-lg shadow-sm">
                                    <div className="grid grid-cols-[200px_1fr] gap-4 mb-6">
                                        <div className="font-bold text-gray-700 text-right">Sector Skill Council :</div>
                                        <div className="text-gray-600">Beauty Wellness Sector Skill Council</div>

                                        <div className="font-bold text-gray-700 text-right">Qualification Pack :</div>
                                        <div className="text-gray-600">Assistant Hair Dresser & Stylist</div>
                                    </div>

                                    <div className="space-y-4">
                                        <p className="text-gray-700 font-medium">
                                            <span className="font-bold">Note :</span> It will accept only Excel files with *.xls extension only.
                                        </p>
                                        <p className="text-gray-700">
                                            Use the same format as given below : <a href="#" className="text-green-500 hover:underline">Download</a>
                                        </p>

                                        {/* Format Table */}
                                        <div className="border border-gray-200 rounded overflow-hidden mb-6">
                                            <table className="w-full text-left border-collapse">
                                                <thead>
                                                    <tr className="bg-gray-50">
                                                        <th className="p-3 border border-gray-200 font-bold text-gray-700">BatchName</th>
                                                        <th className="p-3 border border-gray-200 font-bold text-gray-700">Enrollment No</th>
                                                        <th className="p-3 border border-gray-200 font-bold text-gray-700">Name of Training Agency</th>
                                                        <th className="p-3 border border-gray-200 font-bold text-gray-700">Name of the Trainee</th>
                                                        <th className="p-3 border border-gray-200 font-bold text-gray-700">Gender(M/F/T)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td className="p-8 border border-gray-200"></td>
                                                        <td className="p-8 border border-gray-200"></td>
                                                        <td className="p-8 border border-gray-200"></td>
                                                        <td className="p-8 border border-gray-200"></td>
                                                        <td className="p-8 border border-gray-200"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* File Input */}
                                        <div className="bg-gray-100 p-6 rounded border border-gray-200">
                                            <label className="block font-bold text-red-500 mb-2">* Select Excel File :</label>
                                            <div className="flex bg-white border border-gray-300 rounded p-1 max-w-md">
                                                <input id="bulkImportFile" type="file" accept=".xlsx, .xls" className="w-full p-1" />
                                            </div>
                                        </div>

                                        <div className="pt-4">
                                            <button onClick={handleBulkStudentImport} className="bg-red-500 text-white px-6 py-3 rounded shadow hover:bg-red-600 font-medium">
                                                Validate Sheet
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showCreateModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto font-sans">
                            <div className="bg-white rounded-none w-full max-w-4xl my-8 shadow-2xl">
                                {/* Header */}
                                <div className="bg-gray-600 text-white px-6 py-4 flex items-center gap-2">
                                    <Icons.BarChart2 className="w-5 h-5" />
                                    <h3 className="font-medium text-lg">Add New Batch</h3>
                                </div>

                                <form onSubmit={handleCreateBatch} className="p-8">
                                    <div className="grid grid-cols-2 gap-x-12 gap-y-6">
                                        {/* Left Column */}
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Batch Name:</label>
                                                <div className="col-span-2">
                                                    <input required className="w-full p-2 border border-gray-300 rounded text-sm placeholder-gray-400"
                                                        placeholder="Batch Name"
                                                        value={newBatch.name} onChange={e => setNewBatch({ ...newBatch, name: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Select Project :</label>
                                                <div className="col-span-2 flex gap-2">
                                                    {showNewProjectInput ? (
                                                        <input className="w-full p-2 border border-gray-300 rounded text-sm"
                                                            placeholder="Enter Project Name"
                                                            value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })}
                                                            onBlur={() => !newBatch.project && setShowNewProjectInput(false)}
                                                            autoFocus
                                                        />
                                                    ) : (
                                                        <select className="flex-1 p-2 border border-gray-300 rounded text-sm bg-white"
                                                            value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })}
                                                        >
                                                            <option value="">Select Project</option>
                                                            {projects.map(p => <option key={p} value={p}>{p}</option>)}
                                                        </select>
                                                    )}

                                                    {!showNewProjectInput && (
                                                        <button type="button" onClick={() => setShowNewProjectInput(true)}
                                                            className="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 whitespace-nowrap flex items-center gap-1">
                                                            <Icons.Plus className="w-3 h-3" /> New Project
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Training Centre :</label>
                                                <div className="col-span-2">
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white"
                                                        value={newBatch.trainingCentre} onChange={handleTCSelection}
                                                    >
                                                        <option value="">Select Training Centre</option>
                                                        {trainingCentres.map(tc => <option key={tc.id} value={tc.name}>{tc.name}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">State:</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500"
                                                        value={newBatch.state}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Spoc Contact No:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Center Contact No"
                                                        value={newBatch.spocContactNo} onChange={e => setNewBatch({ ...newBatch, spocContactNo: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-start pt-2">
                                                <label className="text-xs font-bold text-gray-700 mt-1">Center Address:</label>
                                                <div className="col-span-2">
                                                    <textarea rows="3" className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400 resize-none"
                                                        placeholder="Center Address"
                                                        value={newBatch.centerAddress} onChange={e => setNewBatch({ ...newBatch, centerAddress: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Assessment Start Date :</label>
                                                <div className="col-span-2 relative">
                                                    <input type="date" required className="w-full p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.startDate ? newBatch.startDate.split('T')[0] : ''}
                                                        onChange={e => setNewBatch({ ...newBatch, startDate: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Assessment End Date :</label>
                                                <div className="col-span-2 relative">
                                                    <input type="date" required className="w-full p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.endDate}
                                                        onChange={e => setNewBatch({ ...newBatch, endDate: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Login Restrict Count:</label>
                                                <div className="col-span-2">
                                                    <input type="number" className="w-full p-2 border border-gray-300 rounded text-sm"
                                                        value={newBatch.loginRestrictCount} onChange={e => setNewBatch({ ...newBatch, loginRestrictCount: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Mode Of Assessment :</label>
                                                <div className="col-span-2">
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white"
                                                        value={newBatch.modeOfAssessment} onChange={e => setNewBatch({ ...newBatch, modeOfAssessment: e.target.value })}
                                                    >
                                                        <option value="">--Select--</option>
                                                        {assessmentModes.map(m => <option key={m} value={m}>{m}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Right Column */}
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Batch Size:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm placeholder-gray-400"
                                                        placeholder="Batch Size"
                                                        value={newBatch.batchSize} onChange={e => setNewBatch({ ...newBatch, batchSize: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Center ID :</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500 placeholder-gray-400"
                                                        placeholder="Center ID"
                                                        value={newBatch.centerId}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">District:</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500"
                                                        value={newBatch.district}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Spoc EmailID:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Center EmailID"
                                                        value={newBatch.spocEmail} onChange={e => setNewBatch({ ...newBatch, spocEmail: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">T.P Name:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Training Partner Name"
                                                        value={newBatch.tpName} onChange={e => setNewBatch({ ...newBatch, tpName: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Start Time:</label>
                                                <div className="col-span-2 flex gap-2">
                                                    <input type="time" className="flex-1 p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.startTime} onChange={e => setNewBatch({ ...newBatch, startTime: e.target.value })}
                                                    />
                                                    <select className="p-2 border border-gray-300 rounded text-sm bg-white">
                                                        <option>AM</option>
                                                        <option>PM</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">End Time:</label>
                                                <div className="col-span-2 flex gap-2">
                                                    <input type="time" className="flex-1 p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.endTime} onChange={e => setNewBatch({ ...newBatch, endTime: e.target.value })}
                                                    />
                                                    <select className="p-2 border border-gray-300 rounded text-sm bg-white">
                                                        <option>PM</option>
                                                        <option>AM</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="flex items-center gap-2 text-xs font-bold text-gray-700 cursor-pointer select-none">
                                                    <input type="checkbox" className="w-4 h-4 text-blue-600 rounded"
                                                        checked={newBatch.captureImage} onChange={e => setNewBatch({ ...newBatch, captureImage: e.target.checked })}
                                                    />
                                                    Capture Image
                                                </label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm placeholder-gray-400"
                                                        placeholder="Camera Interval in Seconds."
                                                        value={newBatch.cameraInterval} onChange={e => setNewBatch({ ...newBatch, cameraInterval: e.target.value })}
                                                        disabled={!newBatch.captureImage}
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Footer */}
                                    <div className="flex gap-4 justify-start pt-8 mt-4">
                                        <button type="submit" className="px-8 py-2 bg-green-500 text-white rounded text-sm font-medium hover:bg-green-600 shadow-sm">Save</button>
                                        <button type="button" onClick={() => setShowCreateModal(false)} className="px-6 py-2 bg-white text-gray-600 hover:bg-gray-50 rounded text-sm font-medium border border-gray-300">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showAssignModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-xl font-bold mb-4">Assign {assignmentType} QP</h3>
                                <div className="space-y-4">
                                    <p className="text-gray-600">Assigning to batch: <span className="font-bold">{selectedBatch?.name}</span></p>

                                    {/* Modal Filters */}
                                    <div className="space-y-4 mb-4 bg-gray-50 p-3 rounded">
                                        <div>
                                            <label className="text-xs font-bold text-gray-700 block mb-1">Sector Skill Council</label>
                                            <select className="w-full p-2 border rounded text-sm" value={assignSSC} onChange={e => { setAssignSSC(e.target.value); setAssignQPDef(''); setSelectedAssignQP(''); }}>
                                                <option value="">Select SSC</option>
                                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-700 block mb-1">Qualification Pack</label>
                                            <select className="w-full p-2 border rounded text-sm" value={assignQPDef} onChange={e => { setAssignQPDef(e.target.value); setSelectedAssignQP(''); }}>
                                                <option value="">Select QP</option>
                                                {qpList.filter(q => !assignSSC || q.sscId === assignSSC).map(q => <option key={q.id} value={q.id}>{q.name} ({q.code})</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <label className="text-xs font-bold text-gray-700 block mb-1">Select Question Paper</label>
                                    <select className="w-full px-4 py-2 border rounded mb-4" value={selectedAssignQP} onChange={e => setSelectedAssignQP(e.target.value)}>
                                        <option value="">Select Question Paper</option>
                                        {questionPapers.filter(qp => (!assignSSC || qp.sscId === assignSSC) && (!assignQPDef || qp.qpId === assignQPDef)).map(qp => <option key={qp.id} value={qp.id}>{qp.qpName}</option>)}
                                    </select>
                                    <div className="flex gap-2">
                                        <button onClick={handleAssignQP} className="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Assign</button>
                                        <button onClick={() => setShowAssignModal(false)} className="flex-1 bg-gray-100 text-gray-600 py-2 rounded hover:bg-gray-200">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showStudentModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl my-8">
                                <div className="bg-gray-100 px-6 py-4 flex justify-between items-center border-b">
                                    <h3 className="text-xl font-bold text-gray-800">Students</h3>
                                    <button onClick={() => setShowStudentModal(false)} className="text-gray-500 hover:text-red-500">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="p-8">
                                    <div className="grid grid-cols-[200px_1fr] gap-4 mb-6">
                                        <div className="font-bold text-gray-700 text-right">Sector Skill Council :</div>
                                        <div className="text-gray-600">{sscList.find(s => s.id === selectedBatch?.sscId)?.name || 'Apparel'}</div>

                                        <div className="font-bold text-gray-700 text-right">Qualification Pack :</div>
                                        <div className="text-gray-600">{qpList.find(q => q.id === selectedBatch?.theoryPaperId)?.name || 'Advanced Course for Stylist'}</div>
                                    </div>

                                    <div className="flex justify-between items-center mb-4">
                                        <div className="flex items-center gap-2 text-gray-700 font-medium">
                                            <Icons.Users className="w-5 h-5 text-blue-500" />
                                            <span>Total Records : {selectedBatch ? window.Utils.getStudentsByBatch(selectedBatch.id).length : 0}</span>
                                        </div>
                                        <div className="bg-gray-100 p-2 rounded border border-dashed border-gray-300 flex items-center gap-2">
                                            <span className="text-xs font-bold text-gray-500">Add Students:</span>
                                            <input type="file" accept=".xlsx, .xls" onChange={handleStudentUpload} className="text-xs" />
                                        </div>
                                    </div>

                                    <div className="bg-white border rounded shadow-sm overflow-hidden">
                                        <table className="w-full text-left">
                                            <thead className="bg-gray-50 border-b">
                                                <tr>
                                                    <th className="p-3 font-bold text-gray-700 border-r w-24">Photo</th>
                                                    <th className="p-3 font-bold text-gray-700 border-r">Enrollment No</th>
                                                    <th className="p-3 font-bold text-gray-700 border-r">User Name</th>
                                                    <th className="p-3 font-bold text-gray-700 border-r">Student Name</th>
                                                    <th className="p-3 font-bold text-gray-700 w-24 text-center">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {selectedBatch && window.Utils.getStudentsByBatch(selectedBatch.id).map((student, idx) => (
                                                    <tr key={student.id} className="hover:bg-gray-50">
                                                        <td className="p-3 border-r text-center">
                                                            <div className="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500 mx-auto">
                                                                No Image
                                                            </div>
                                                        </td>
                                                        <td className="p-3 border-r text-gray-700">{student.enrollmentNo || student.username}</td>
                                                        <td className="p-3 border-r text-gray-700">{student.username}</td>
                                                        <td className="p-3 border-r text-gray-700">{student.name}</td>
                                                        <td className="p-3 text-center">
                                                            <button onClick={() => {
                                                                if (confirm('Delete Student ' + student.name + '?')) {
                                                                    window.Utils.deleteStudent(student.id);
                                                                    setSelectedBatch({ ...selectedBatch }); // Force re-render
                                                                }
                                                            }} className="text-red-500 hover:text-red-700 p-2" title="Delete Student">
                                                                <Icons.Trash2 className="w-4 h-4" />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {(!selectedBatch || window.Utils.getStudentsByBatch(selectedBatch.id).length === 0) && (
                                                    <tr>
                                                        <td colSpan="5" className="p-8 text-center text-gray-400">No students found in this batch.</td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // RESULTS TAB
        const ResultsTab = () => {
            const [batches, setBatches] = useState([]);
            const [selectedBatch, setSelectedBatch] = useState(null);
            const [examType, setExamType] = useState(null);
            const [students, setStudents] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [evidence, setEvidence] = useState([]);
            const [evidenceFilter, setEvidenceFilter] = useState('ALL'); // ALL, PHOTO, VIDEO, WARNING
            const [answers, setAnswers] = useState({});

            useEffect(() => setBatches(window.Utils.getBatches()), []);

            const loadResults = (type) => {
                setExamType(type);
                setStudents(window.Utils.getStudentsByBatch(selectedBatch.id));
            };

            const viewEvidence = (student) => {
                setSelectedStudent(student);
                const responses = window.Utils.getResponses();
                const resp = responses.find(r => r.studentId === student.id && r.examType === examType);
                setEvidence(resp?.evidence || []);
                setAnswers(resp?.answers || {});
            };

            const downloadAllEvidence = async () => {
                if (!evidence || evidence.length === 0) return;
                const zip = new JSZip();
                const folder = zip.folder(`evidence_${selectedStudent.username}`);

                let count = 0;

                for (let i = 0; i < evidence.length; i++) {
                    const e = evidence[i];
                    // Skip Warnings as requested
                    if (e.type === 'VIOLATION_LOG' || e.type === 'VIDEO_DOWNLOADED') continue;

                    const time = new Date(e.time).getTime();

                    if (e.type === 'VIDEO_INDEXED_DB') {
                        try {
                            const blob = await VideoDB.getVideo(e.key);
                            if (blob) {
                                folder.file(`video_${time}.webm`, blob);
                                count++;
                            }
                        } catch (err) { console.error("Error zipping video", err); }
                    } else if (e.img) {
                        try {
                            // Data URL
                            const base64Data = e.img.split(',')[1];
                            const ext = (e.type.includes('VIDEO')) ? 'webm' : 'jpg';
                            folder.file(`capture_${time}.${ext}`, base64Data, { base64: true });
                            count++;
                        } catch (err) { console.error("Error zipping image", err); }
                    }
                }

                if (count > 0) {
                    zip.generateAsync({ type: "blob" }).then(content => {
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(content);
                        a.download = `Evidence_${selectedStudent.username}_${new Date().toISOString().split('T')[0]}.zip`;
                        a.click();
                        alert(`Download Started! (${count} files)`);
                    });
                } else {
                    alert("No downloadable evidence found (warnings excluded).");
                }
            };


            if (!selectedBatch) return (
                <div className="grid gap-4 md:grid-cols-2">
                    {batches.map(b => (
                        <div key={b.id} onClick={() => setSelectedBatch(b)} className="bg-white p-6 rounded shadow cursor-pointer hover:shadow-lg">
                            <h3 className="font-bold text-lg">{b.name}</h3>
                            <p className="text-gray-500">{b.startDate} - {b.endDate}</p>
                        </div>
                    ))}
                </div>
            );

            if (!examType) return (
                <div>
                    <button onClick={() => setSelectedBatch(null)} className="mb-4 text-indigo-600">Back</button>
                    <h3 className="text-xl font-bold mb-4">Select Exam Type</h3>
                    <div className="flex gap-4">
                        {['Theory', 'Practical'].map(t => (
                            <button key={t} onClick={() => loadResults(t)} className="flex-1 bg-white p-8 rounded shadow text-xl font-bold hover:shadow-lg">{t}</button>
                        ))}
                    </div>
                </div>
            );

            if (!selectedStudent) return (
                <div>
                    <button onClick={() => setExamType(null)} className="mb-4 text-indigo-600">Back</button>
                    <h3 className="text-xl font-bold mb-4">{selectedBatch.name} - {examType} Results</h3>
                    <div className="bg-white rounded overflow-hidden shadow">
                        {students.map((s, i) => (
                            <div key={s.id} className="p-4 border-b flex justify-between items-center">
                                <span>{i + 1}. {s.name} ({s.username})</span>
                                <button onClick={() => viewEvidence(s)} className="text-indigo-600">View Evidence</button>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div>
                    <button onClick={() => setSelectedStudent(null)} className="mb-4 text-indigo-600">Back</button>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold">Evidence: {selectedStudent.name}</h3>
                        <button onClick={downloadAllEvidence} className="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2 font-bold transition-transform hover:scale-105">
                            <Icons.Save className="w-4 h-4" /> Download All (ZIP)
                        </button>
                    </div>
                    <div className="bg-white p-6 rounded shadow">

                        <div className="flex gap-2 mb-4 border-b pb-2">
                            {['ALL', 'PHOTO', 'VIDEO', 'WARNING'].map(f => (
                                <button key={f} onClick={() => setEvidenceFilter(f)}
                                    className={`px-4 py-1 rounded-full text-sm font-bold ${evidenceFilter === f ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    {f === 'ALL' ? 'All Evidence' : f + 'S'}
                                </button>
                            ))}
                        </div>

                        <h4 className="font-bold mb-2">Evidence Gallery</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            {evidence.filter(e => {
                                if (evidenceFilter === 'ALL') return true;
                                if (evidenceFilter === 'VIDEO') return e.type === 'AUTO_CAPTURE_VIDEO' || e.type.includes('VIDEO') || e.type === 'VIDEO_DOWNLOADED';
                                if (evidenceFilter === 'PHOTO') return e.type === 'AUTO_CAPTURE_PHOTO';
                                if (evidenceFilter === 'WARNING') return e.type === 'VIOLATION_LOG';
                                return true;
                            }).map((e, i) => (
                                <div key={i} className="border rounded p-2 bg-gray-50">
                                    <div className="text-xs text-gray-500 mb-1 flex justify-between">
                                        <span>{new Date(e.time).toLocaleTimeString()}</span>
                                        <span className="font-bold">{e.type === 'AUTO_CAPTURE_VIDEO' || e.type === 'VIDEO_DOWNLOADED' ? 'VIDEO' : (e.type === 'VIOLATION_LOG' ? 'WARNING' : 'PHOTO')}</span>
                                    </div>
                                    {e.type === 'VIOLATION_LOG' ? (
                                        <div className="bg-red-50 text-red-700 p-4 rounded border border-red-200 h-32 overflow-y-auto flex items-center justify-center text-center font-bold">
                                            <Icons.TriangleAlert className="w-5 h-5 mr-2 inline" />
                                            {e.message}
                                        </div>
                                    ) : e.type === 'VIDEO_INDEXED_DB' ? (
                                        <VideoPlayerDB videoKey={e.key} />
                                    ) : e.type === 'VIDEO_DOWNLOADED' ? (
                                        <div className="bg-blue-50 text-blue-700 p-4 rounded border border-blue-200 h-32 flex flex-col items-center justify-center text-center font-bold">
                                            <Icons.Video className="w-8 h-8 mb-2" />
                                            <span>Video Saved on Student Device</span>
                                            <span className="text-xs font-normal mt-1">(Click to view details)</span>
                                        </div>
                                    ) : (e.type === 'AUTO_CAPTURE_VIDEO' || e.type.includes('VIDEO')) ? (
                                        <div className="relative">
                                            <video src={e.img} controls className="w-full rounded bg-black" />
                                            <a href={e.img} download={`video_${i}.webm`} className="absolute bottom-2 right-2 bg-white/80 p-1 rounded text-xs hover:bg-white"><Icons.Save className="w-3 h-3" /> Download</a>
                                        </div>
                                    ) : (
                                        <img src={e.img} className="w-full rounded border" />
                                    )}
                                </div>
                            ))}
                            {evidence.length === 0 && <span className="text-gray-400 col-span-3 text-center py-4">No evidence captured yet</span>}
                        </div>
                        <h4 className="font-bold mb-2">Answers</h4>
                        <div className="space-y-2">
                            {Object.entries(answers).map(([qIdx, ans]) => (
                                <div key={qIdx} className="bg-gray-50 p-2 rounded text-sm">
                                    <span className="font-bold text-gray-500">Q{parseInt(qIdx) + 1}:</span> {ans}
                                </div>
                            ))}
                            {Object.keys(answers).length === 0 && <span className="text-gray-400">No answers</span>}
                        </div>
                    </div>
                </div>
            );
        };

        // ADMIN DASHBOARD
        const AdminDashboard = () => {
            const [activeTab, setActiveTab] = useState('qps');
            const [selectedQPForNOS, setSelectedQPForNOS] = useState(null);

            const handleNavigateToNOS = (qp) => {
                setSelectedQPForNOS(qp);
                setActiveTab('nos');
            };

            return (
                <div className="flex bg-gray-100 min-h-screen">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <div className="flex-1 overflow-auto h-screen">
                        {/* Header */}
                        <header className="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
                            <div className="flex items-center text-sm text-gray-500">
                                <span className="hover:text-gray-700 cursor-pointer">Home</span>
                                <Icons.ChevronRight />
                                <span className="font-medium text-gray-900 capitalize">{activeTab.replace(/([A-Z])/g, ' $1')}</span>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">A</div>
                                <span className="text-sm font-medium">Administrator</span>
                            </div>
                        </header>

                        <div className="p-8">
                            {activeTab === 'dashboard' && <div className="text-center text-gray-400 mt-20">Dashboard Component Placeholder</div>}
                            {activeTab === 'calendar' && <div className="text-center text-gray-400 mt-20">Calendar Component Placeholder</div>}
                            {activeTab === 'location' && <div className="text-center text-gray-400 mt-20">Assessment Location Component Placeholder</div>}

                            {activeTab === 'subjects' && <SubjectsTab />}
                            {activeTab === 'qps' && <QPsTab onNavigateToNOS={handleNavigateToNOS} />}
                            {activeTab === 'nos' && <NOSPC_Tab selectedQP={selectedQPForNOS} onBack={() => { setSelectedQPForNOS(null); setActiveTab('qps'); }} />}
                            {activeTab === 'questionPapers' && <QuestionPapersTab />}
                            {activeTab === 'batches' && <BatchesTab />}
                            {activeTab === 'results' && <ResultsTab />}
                        </div>
                    </div>
                </div>
            );
        };

        // Helper Component: Video from IndexedDB
        const VideoPlayerDB = ({ videoKey }) => {
            const [url, setUrl] = useState(null);
            const [status, setStatus] = useState('loading');

            useEffect(() => {
                VideoDB.getVideo(videoKey).then(blob => {
                    if (blob) {
                        setUrl(URL.createObjectURL(blob));
                        setStatus('ready');
                    } else {
                        setStatus('error');
                    }
                }).catch(() => setStatus('error'));
            }, [videoKey]);

            if (status === 'loading') return <div className="p-4 text-gray-500 text-center text-xs">Loading Video...</div>;
            if (status === 'error') return <div className="p-4 text-red-500 text-center text-xs">Video File Not Found</div>;

            return (
                <div className="relative">
                    <video src={url} controls className="w-full rounded bg-black" />
                    <a href={url} download={`exam_video_${videoKey}.webm`} className="absolute bottom-2 right-2 bg-white/80 p-1 rounded text-xs hover:bg-white flex items-center shadow">
                        <Icons.Save className="w-3 h-3 mr-1" /> Download
                    </a>
                </div>
            );
        };

        // STUDENT PORTAL
        const StudentPortal = ({ user }) => {
            const [examMode, setExamMode] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [currentQ, setCurrentQ] = useState(0);
            const [answers, setAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(0);
            const [webcamActive, setWebcamActive] = useState(false);

            // PROCTORING STATE
            const [warnings, setWarnings] = useState(0);
            const [isLocked, setIsLocked] = useState(false);
            const [proctoringModel, setProctoringModel] = useState(null);
            const [proctoringLogs, setProctoringLogs] = useState([]);
            const [lastWarning, setLastWarning] = useState(null); // State for Visual Alert
            // State for Visual Alert
            const detectionInterval = useRef(null);
            const autoCaptureInterval = useRef(null);
            const mediaRecorderRef = useRef(null);
            const videoChunksRef = useRef([]);
            const recordingExamType = useRef(null); // Persist exam type for the recording session
            const [isRecording, setIsRecording] = useState(false); // UI Indicator


            // No need for syncing effect that clears on null

            // Load Model
            useEffect(() => {
                if (window.cocoSsd) {
                    window.cocoSsd.load().then(model => {
                        console.log("Proctoring Model Loaded");
                        setProctoringModel(model);
                    });
                }
            }, []);

            // Check Lock Status on Load
            useEffect(() => {
                const checkLock = () => {
                    const status = JSON.parse(localStorage.getItem('se_student_lock_' + user.id) || 'null');
                    if (status && status.isLocked) {
                        setIsLocked(true);
                        setWarnings(status.warnings);
                    }
                };
                checkLock();
                const interval = setInterval(checkLock, 2000); // Poll for unlock
                return () => clearInterval(interval);
            }, [user.id]);

            // Save Lock Status
            const updateLockStatus = (newWarnings, locked) => {
                setWarnings(newWarnings);
                if (locked) setIsLocked(true);
                localStorage.setItem('se_student_lock_' + user.id, JSON.stringify({ isLocked: locked, warnings: newWarnings }));
            };

            // Log Violation
            const logViolation = (msg) => {
                if (isLocked) return;
                const newWarnings = warnings + 1;
                const log = `${new Date().toLocaleTimeString()}: ${msg} (Strike ${newWarnings}/5)`;
                setProctoringLogs(prev => [log, ...prev]);

                // Show Visual Warning
                setLastWarning(`${msg} (Strike ${newWarnings}/5)`);
                setTimeout(() => setLastWarning(null), 4000); // Hide after 4s

                // SAVE VIOLATION AS EVIDENCE
                window.Utils.saveResponse({
                    studentId: user.id,
                    examType: examMode,
                    evidence: [{ img: null, time: new Date().toISOString(), type: 'VIOLATION_LOG', message: msg }]
                });

                updateLockStatus(newWarnings, newWarnings >= 5);
                if (newWarnings >= 5) {
                    alert("Maximum violations reached. Exam Locked. Contact Assessor.");
                }
            };

            // 60-Second Auto-Capture Loop
            useEffect(() => {
                if (!examMode || isLocked) {
                    if (autoCaptureInterval.current) clearInterval(autoCaptureInterval.current);
                    return;
                }

                autoCaptureInterval.current = setInterval(() => {
                    const video = document.getElementById('student-cam');
                    if (video && video.readyState === 4) {
                        const c = document.createElement('canvas'); c.width = 320; c.height = 240; // Smaller resolution for storage
                        c.getContext('2d').drawImage(video, 0, 0, c.width, c.height);
                        const img = c.toDataURL('image/jpeg', 0.5); // Low quality

                        window.Utils.saveResponse({
                            studentId: user.id,
                            examType: examMode,
                            evidence: [{ img, time: new Date().toISOString(), type: 'AUTO_CAPTURE_PHOTO' }]
                        });
                        // console.log("Auto-Captured Evidence");
                    }
                }, 10000); // 10 Seconds

                return () => clearInterval(autoCaptureInterval.current);
            }, [examMode, isLocked, user.id]);

            // Full Video Recording Logic
            useEffect(() => {
                if (!examMode || isLocked || !webcamActive) {
                    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                        mediaRecorderRef.current.stop();
                        setIsRecording(false);
                    }
                    return;
                }

                // Start Recording
                const startRecording = async () => {
                    const stream = document.getElementById('student-cam')?.srcObject;
                    if (stream) {
                        videoChunksRef.current = [];
                        recordingExamType.current = examMode; // CAPTURE TYPE AT START
                        try {
                            // Try optimal codec, fallback if needed
                            let options = { mimeType: 'video/webm; codecs=vp8' };
                            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                                console.warn("VP8 not supported, falling back to default webm");
                                options = { mimeType: 'video/webm' };
                            }

                            const recorder = new MediaRecorder(stream, options);
                            recorder.ondataavailable = e => { if (e.data.size > 0) videoChunksRef.current.push(e.data); };
                            recorder.onstop = () => {
                                setIsRecording(false);
                                const blob = new Blob(videoChunksRef.current, { type: 'video/webm' });
                                const savedExamType = recordingExamType.current; // READ CAPTURED TYPE
                                console.log(`Video Recording Stopped. Size: ${blob.size} bytes. Exam Type: ${savedExamType}`);

                                // SAVE TO INDEXED DB
                                const videoKey = `video_${user.id}_${savedExamType}`;
                                VideoDB.saveVideo(videoKey, blob).then(() => {
                                    console.log("Video saved to IndexedDB:", videoKey);
                                    if (savedExamType) {
                                        window.Utils.saveResponse({
                                            studentId: user.id,
                                            examType: savedExamType,
                                            evidence: [{ img: null, time: new Date().toISOString(), type: 'VIDEO_INDEXED_DB', key: videoKey }]
                                        });
                                    }
                                }).catch(err => {
                                    console.error("IndexedDB Save Failed", err);
                                    // Fallback to Download
                                    alert("Browser storage failed. Downloading video manually.");
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a'); a.href = url; a.download = `exam_recording_${user.username}_${new Date().getTime()}.webm`; a.click();
                                });
                                return;

                                /* 
                                // REMOVED: Auto Download Logic
                                if (blob.size > 100) { ... } 
                                */

                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    try {
                                        console.log("Saving Video Evidence for:", savedExamType);
                                        if (savedExamType) {
                                            window.Utils.saveResponse({
                                                studentId: user.id,
                                                examType: savedExamType,
                                                evidence: [{ img: reader.result, time: new Date().toISOString(), type: 'AUTO_CAPTURE_VIDEO' }]
                                            });
                                        } else {
                                            console.error("Exam Type lost during recording");
                                        }
                                    } catch (err) {
                                        console.error("Video too large for storage", err);
                                        // Fallback just in case
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a'); a.href = url; a.download = `exam_recording_${user.username}.webm`; a.click();
                                    }
                                };
                                reader.readAsDataURL(blob);
                            };
                            recorder.start(5000); // 5s chunks
                            mediaRecorderRef.current = recorder;
                            setIsRecording(true);
                            console.log("Recording Started");
                        } catch (e) {
                            console.error("MediaRecorder Error", e);
                            alert("Camera Recording Failed: " + e.message);
                        }
                    }
                };



                // Poll until stream is ready, then start
                const attemptStart = setInterval(() => {
                    const stream = document.getElementById('student-cam')?.srcObject;
                    if (stream && stream.active) {
                        clearInterval(attemptStart);
                        startRecording();
                    } else if (!examMode || isLocked) {
                        clearInterval(attemptStart);
                    }
                }, 500);

                return () => clearInterval(attemptStart);
            }, [examMode, webcamActive, isLocked]);

            // Visibility (Tab Switch) Listener
            useEffect(() => {
                if (!examMode || isLocked) return;

                const handleVisibility = () => {
                    if (document.hidden) {
                        logViolation("Tab Switch / Minimized Browser");
                    }
                };

                document.addEventListener('visibilitychange', handleVisibility);
                return () => document.removeEventListener('visibilitychange', handleVisibility);
            }, [examMode, isLocked, warnings]);

            // Object Detection Loop
            useEffect(() => {
                if (!examMode || !webcamActive || isLocked || !proctoringModel) {
                    if (detectionInterval.current) clearInterval(detectionInterval.current);
                    return;
                }

                detectionInterval.current = setInterval(async () => {
                    const video = document.getElementById('student-cam');
                    if (video && video.readyState === 4) {
                        const predictions = await proctoringModel.detect(video);

                        // Check for Mobile Phone
                        const hasPhone = predictions.some(p => p.class === 'cell phone' || p.class === 'remote'); // cell phone usually
                        if (hasPhone) {
                            logViolation("Mobile Device Detected");
                        }

                        // Check for Person Count
                        const personCount = predictions.filter(p => p.class === 'person').length;
                        if (personCount > 1) {
                            logViolation("Multiple Persons Detected");
                        }
                        // Note: If personCount === 0, maybe student left? (Empty chair). Optional feature.
                        if (personCount === 0) {
                            // logViolation("No Person Detected"); 
                        }
                    }
                }, 3000); // Check every 3 seconds

                return () => clearInterval(detectionInterval.current);
            }, [examMode, webcamActive, isLocked, proctoringModel, warnings]);

            useEffect(() => {
                let interval;
                if (examMode && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                return () => clearInterval(interval);
            }, [examMode, timeLeft]);

            const startExam = (mode) => {
                const batch = window.Utils.getBatches().find(b => b.id === user.batchId);
                const pid = mode === 'Theory' ? batch.theoryPaperId : batch.practicalPaperId;
                const qp = window.Utils.getQuestionPapers().find(q => q.id === pid);
                if (qp) {
                    setQuestions(qp.questions);
                    setTimeLeft(qp.totalTime * 60);
                    setExamMode(mode);
                    setWebcamActive(true);
                    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                        document.getElementById('student-cam').srcObject = stream;
                    });
                } else {
                    alert('Exam not assigned');
                }
            };

            const submitExam = () => {
                // Capture final image
                const v = document.getElementById('student-cam');
                const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                c.getContext('2d').drawImage(v, 0, 0, 300, 200);

                window.Utils.saveResponse({
                    studentId: user.id,
                    examType: examMode,
                    answers,
                    evidence: [{ img: c.toDataURL(), time: new Date().toISOString(), type: 'SUBMISSION' }]
                });
                alert('Submitted!');
                setExamMode(null);
                setWebcamActive(false);
            };

            if (examMode) {
                if (isLocked) return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-red-50 flex-col items-center justify-center text-center p-8 box-border">
                        <Icons.Lock className="w-24 h-24 text-red-600 mb-6" />
                        <h1 className="text-4xl font-bold text-red-700 mb-4">Exam Locked</h1>
                        <p className="text-xl text-gray-700 mb-8">You have exceeded the maximum number of warnings (5/5).<br />Please contact your Assessor to unlock your exam.</p>
                        <div className="bg-white p-6 rounded shadow max-w-md w-full text-left">
                            <h3 className="font-bold mb-2">Violation Log:</h3>
                            <ul className="text-sm text-red-600 list-disc pl-5 max-h-48 overflow-y-auto">
                                {proctoringLogs.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                    </div>
                );

                return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-white">
                        <div className="w-3/4 p-8 overflow-y-auto">
                            <div className="flex justify-between mb-4">
                                <h2 className="font-bold text-xl">Exam: {examMode}</h2>
                                <div className="flex items-center gap-4">
                                    <div className={`px-4 py-1 rounded font-bold ${warnings > 2 ? 'bg-red-100 text-red-700' : (warnings > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700')}`}>
                                        Warnings: {warnings}/5
                                    </div>
                                    <div className="font-mono text-xl">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                                </div>
                            </div>
                            {lastWarning && (
                                <div className="bg-red-600 text-white p-4 rounded shadow-lg mb-6 text-center font-bold text-lg animate-pulse flex items-center justify-center">
                                    <Icons.TriangleAlert className="inline w-8 h-8 mr-3" />
                                    <span>WARNING: {lastWarning}</span>
                                </div>
                            )}
                            {questions[currentQ] && (
                                <div>
                                    <h3 className="text-lg font-medium mb-4">Q{currentQ + 1}: {questions[currentQ].question}</h3>
                                    {questions[currentQ].questionType === 'CODING' ? (
                                        <textarea className="w-full h-64 p-4 border rounded font-mono" value={answers[currentQ] || ''} onChange={e => setAnswers({ ...answers, [currentQ]: e.target.value })}></textarea>
                                    ) : (
                                        <div className="space-y-2">
                                            {questions[currentQ].options.map(o => (
                                                <button key={o} onClick={() => setAnswers({ ...answers, [currentQ]: o })}
                                                    className={`w-full text-left p-3 border rounded ${answers[currentQ] === o ? 'bg-indigo-100 border-indigo-500' : ''}`}>{o}</button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                            <div className="mt-6 flex justify-between">
                                <button disabled={currentQ === 0} onClick={() => setCurrentQ(c => c - 1)} className="px-4 py-2 border rounded">Prev</button>
                                {currentQ < questions.length - 1 ?
                                    <button onClick={() => setCurrentQ(c => c + 1)} className="px-4 py-2 bg-indigo-600 text-white rounded">Next</button> :
                                    <button onClick={submitExam} className="px-4 py-2 bg-green-600 text-white rounded">Submit Exam</button>
                                }
                            </div>
                        </div>
                        <div className="w-1/4 bg-gray-100 p-4 border-l">
                            <video id="student-cam" autoPlay muted playsInline className="w-full bg-black rounded mb-2"></video>
                            <div className="grid grid-cols-4 gap-2">
                                {questions.map((_, i) => <div key={i} onClick={() => setCurrentQ(i)} className={`h-8 flex items-center justify-center cursor-pointer rounded ${answers[i] ? 'bg-green-200' : 'bg-white'}`}>{i + 1}</div>)}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-8">
                    <h2 className="text-2xl font-bold mb-6">Student Portal</h2>
                    <div className="grid gap-6 md:grid-cols-2">
                        <div onClick={() => startExam('Theory')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-indigo-600">
                            <h3 className="text-xl font-bold text-indigo-900">Theory Exam</h3>
                            <p className="text-gray-500">Multiple choice questions</p>
                            <button className="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">Start</button>
                        </div>
                        <div onClick={() => startExam('Practical')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-purple-600">
                            <h3 className="text-xl font-bold text-purple-900">Practical Exam</h3>
                            <p className="text-gray-500">Coding challenges</p>
                            <button className="mt-4 bg-purple-600 text-white px-4 py-2 rounded">Start</button>
                        </div>
                    </div>
                </div>
            );
        };

        // ASSESSOR PORTAL
        const AssessorPortal = ({ user }) => {
            const [examType, setExamType] = useState(null);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [isRecording, setIsRecording] = useState(false);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);

            const startCam = () => {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                    setTimeout(() => {
                        const v = document.getElementById('assessor-cam');
                        if (v) v.srcObject = stream;
                    }, 100);
                });
            };

            const capturePhoto = () => {
                const v = document.getElementById('assessor-cam');
                const c = document.createElement('canvas'); c.width = 640; c.height = 480;
                c.getContext('2d').drawImage(v, 0, 0);
                saveEvidence(c.toDataURL(), 'MANUAL_CAPTURE_PHOTO');
            };

            const toggleRecording = () => {
                if (isRecording) {
                    if (mediaRecorderRef.current) mediaRecorderRef.current.stop();
                    setIsRecording(false);
                } else {
                    const v = document.getElementById('assessor-cam');
                    if (!v || !v.srcObject) return alert('Camera not active');

                    chunksRef.current = [];
                    const recorder = new MediaRecorder(v.srcObject);
                    recorder.ondataavailable = e => { if (e.data.size > 0) chunksRef.current.push(e.data); };
                    recorder.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'video/webm' });
                        if (blob.size > 2 * 1024 * 1024) alert('Warning: Video is large (' + (blob.size / 1024 / 1024).toFixed(1) + 'MB). Local storage may fill up.');

                        const reader = new FileReader();
                        reader.onloadend = () => {
                            saveEvidence(reader.result, 'MANUAL_CAPTURE_VIDEO');
                        };
                        reader.readAsDataURL(blob);
                    };
                    recorder.start();
                    setIsRecording(true);
                    mediaRecorderRef.current = recorder;
                }
            };

            const saveEvidence = (data, type) => {
                const responses = window.Utils.getResponses();
                let resp = responses.find(r => r.studentId === selectedStudent.id && r.examType === examType);
                if (!resp) { resp = { studentId: selectedStudent.id, examType, evidence: [] }; responses.push(resp); }
                if (!resp.evidence) resp.evidence = [];
                resp.evidence.push({ img: data, time: new Date().toISOString(), type });
                localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(responses));
                alert(type === 'MANUAL_CAPTURE_PHOTO' ? 'Photo Captured!' : 'Video Saved!');
            };

            if (!examType) return (
                <div className="p-8">
                    <h2 className="text-2xl font-bold mb-4">Assessor Portal</h2>
                    <div className="flex gap-4">
                        {['Theory', 'Practical'].map(t => (
                            <button key={t} onClick={() => setExamType(t)} className="flex-1 bg-white p-8 rounded shadow text-xl font-bold">{t}</button>
                        ))}
                    </div>
                </div>
            );

            if (!selectedStudent) return (
                <div className="p-8">
                    <button onClick={() => setExamType(null)} className="mb-4 text-indigo-600">Back</button>
                    <h3 className="font-bold text-xl mb-4">Select Student ({examType})</h3>
                    <div className="bg-white rounded shadow">
                        {window.Utils.getStudentsByBatch(user.batchId).map(s => {
                            const status = JSON.parse(localStorage.getItem('se_student_lock_' + s.id) || 'null');
                            const isLocked = status?.isLocked;
                            return (
                                <div key={s.id} onClick={() => { setSelectedStudent(s); startCam(); }}
                                    className={`p-4 border-b hover:bg-gray-50 cursor-pointer flex justify-between items-center ${isLocked ? 'bg-red-50' : ''}`}>
                                    <span>{s.name}</span>
                                    {isLocked && <span className="bg-red-500 text-white text-xs px-2 py-1 rounded font-bold">LOCKED</span>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            return (
                <div className="p-8">
                    <button onClick={() => setSelectedStudent(null)} className="mb-4 text-indigo-600">Back</button>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="font-bold text-xl">Assessing: {selectedStudent.name}</h2>
                        <button onClick={() => {
                            localStorage.setItem('se_student_lock_' + selectedStudent.id, JSON.stringify({ isLocked: false, warnings: 0 }));
                            alert('Student Unlocked!');
                        }} className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded font-bold flex items-center gap-2 text-sm shadow">
                            <Icons.Unlock className="w-4 h-4" /> Unlock Exam
                        </button>
                    </div>
                    <div className="grid md:grid-cols-2 gap-8">
                        <div>
                            <video id="assessor-cam" autoPlay muted className="w-full bg-black rounded mb-4 shadow-lg"></video>
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={capturePhoto} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded font-bold flex items-center justify-center gap-2">
                                    <Icons.Camera /> Capture Photo
                                </button>
                                <button onClick={toggleRecording} className={`w-full text-white py-3 rounded font-bold flex items-center justify-center gap-2 ${isRecording ? 'bg-red-600 animate-pulse' : 'bg-green-600 hover:bg-green-700'}`}>
                                    {isRecording ? <><Icons.Square /> Stop Video</> : <><Icons.Video /> Start Video</>}
                                </button>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded shadow">
                            <h3 className="font-bold mb-2">Instructions</h3>
                            <ul className="list-disc ml-4 text-gray-600">
                                <li>Verify student identity</li>
                                <li>Monitor coding screen execution</li>
                                <li>Capture evidence periodically</li>
                                <li>Unlock student if exam is locked due to warnings.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        // MAIN APP
        const App = () => {
            const [user, setUser] = useState(null);
            // useEffect(() => { if (window.lucide) window.lucide.createIcons(); }); // REMOVED: Managed by LucideIcon
            if (!user) return <LoginScreen onLogin={setUser} />;
            return (
                <div className="min-h-screen bg-slate-50">
                    <header className="bg-white shadow-sm border-b px-8 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-2 font-bold text-xl text-gray-800">
                            <div className="bg-indigo-600 text-white rounded p-1">N</div> NSXpertise
                        </div>
                        <div className="flex gap-4 items-center">
                            <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase">{user.role}</span>
                            <button onClick={() => setUser(null)} className="text-gray-500 hover:text-red-600 text-sm">Logout</button>
                        </div>
                    </header>
                    <main>
                        <ErrorBoundary>
                            {user.role === 'admin' && <AdminDashboard />}
                            {user.role === 'student' && <StudentPortal user={user} />}
                            {user.role === 'assessor' && <AssessorPortal user={user} />}
                        </ErrorBoundary>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>